

<!-- Payment Links Management Modal -->
<div class="modal fade" id="paymentLinksModal" tabindex="-1" aria-labelledby="paymentLinksModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title" id="paymentLinksModalLabel">
          <i class="fas fa-link me-2"></i>Manage Payment Links
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <!-- Flash Messages for Modal -->
        <div id="modalFlashContainer"></div>

        <!-- Add New Payment Link Card - Toggleable -->
        <div class="card mb-4">
          <div class="card-header toggle-card-header d-flex justify-content-between align-items-center" style="cursor: pointer; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);" id="addLinkCardHeader">
            <h6 class="card-title mb-0 text-primary">
              <i class="fas fa-plus-circle me-2"></i>Add New Payment Link
            </h6>
            <i class="fas fa-chevron-down text-primary" id="addLinkToggleIcon"></i>
          </div>
          <div class="card-body" id="addLinkCardBody" style="display: none;">
            <form id="addPaymentLinkForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="newAmount" class="form-label fw-bold">Amount (TSh)</label>
                  <div class="input-group">
                    <span class="input-group-text">TSh</span>
                    <input type="number" 
                           class="form-control" 
                           id="newAmount" 
                           name="amount"
                           min="100" 
                           step="100" 
                           required
                           placeholder="1000">
                  </div>
                  <div class="form-text">Minimum amount: TSh 100</div>
                </div>
                
                <div class="col-md-6">
                  <label for="newDescription" class="form-label fw-bold">Description</label>
                  <input type="text" 
                         class="form-control" 
                         id="newDescription" 
                         name="description"
                         required
                         placeholder="e.g., 1,000 TSh Contribution">
                  <div class="form-text">Brief description of this payment amount</div>
                </div>
                
                <div class="col-12">
                  <label for="newLipiaLink" class="form-label fw-bold">Lipia Payment Link</label>
                  <textarea class="form-control" 
                            id="newLipiaLink" 
                            name="lipia_link"
                            rows="3" 
                            required
                            placeholder="https://payments.azampay.co.tz/?id=..."></textarea>
                  <div class="form-text">Full Azam Lipia payment URL (this will be hidden from users)</div>
                </div>
              </div>
              
              <div class="mt-3">
                <button type="submit" class="btn btn-success" id="addLinkBtn">
                  <i class="fas fa-save me-2"></i>Add Payment Link
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetFormBtn">
                  <i class="fas fa-redo me-2"></i>Reset Form
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Existing Payment Links Table -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <h6 class="card-title mb-0 text-primary">
              <i class="fas fa-list me-2"></i>Existing Payment Links
            </h6>
            <span class="badge bg-primary" id="linksCount">0 links</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover" id="paymentLinksTable">
                <thead class="table-light">
                  <tr>
                    <th>Amount (TSh)</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="paymentLinksBody">
                  <!-- Payment links will be loaded here dynamically -->
                  <tr id="noLinksRow">
                    <td colspan="4" class="text-center text-muted py-4">
                      <i class="fas fa-link fa-2x mb-3"></i>
                      <p class="mb-0">No payment links configured</p>
                      <small>Add your first payment link using the form above</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Close
        </button>
        <button type="button" class="btn btn-outline-primary" id="refreshLinksBtn">
          <i class="fas fa-sync-alt me-2"></i>Refresh List
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLinkModal" tabindex="-1" aria-labelledby="deleteLinkModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title" id="deleteLinkModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this payment link?</p>
        <div class="alert alert-warning">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Warning:</strong> This action cannot be undone. Users will no longer be able to make payments for this amount.
        </div>
        <div id="deleteLinkDetails" class="mt-3 p-3 bg-light rounded">
          <!-- Link details will be inserted here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash me-2"></i>Delete Payment Link
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .payment-link-row:hover {
    background-color: #f8f9fa;
  }
  .status-badge-active {
    background-color: #28a745;
  }
  .status-badge-inactive {
    background-color: #6c757d;
  }
  .description-text {
    font-weight: 500;
    color: #495057;
  }
  .toggle-card-header {
    transition: all 0.3s ease;
    border: none;
  }
  .toggle-card-header:hover {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%) !important;
    transform: translateY(-1px);
  }
  #addLinkToggleIcon {
    transition: transform 0.3s ease;
  }
  #addLinkToggleIcon.rotated {
    transform: rotate(180deg);
  }
  .modal-header {
    border-bottom: none;
  }
  .card-header {
    border-bottom: 1px solid #dee2e6;
  }
</style>

<script>
// Global variable to track the link being deleted
let currentDeleteLinkId = null;
let isModalOpen = false;

// Safe DOM element getter with null check
function getElementSafe(id) {
  const element = document.getElementById(id);
  if (!element) {
    console.warn(`‚ö†Ô∏è Element with id '${id}' not found`);
  }
  return element;
}

// Safe element display toggle
function safeDisplayToggle(elementId, display) {
  const element = getElementSafe(elementId);
  if (element) {
    element.style.display = display;
  }
}

// Initialize modal when shown
document.getElementById('paymentLinksModal').addEventListener('show.bs.modal', function() {
  isModalOpen = true;
  loadPaymentLinks();
  clearModalForm();
});

// Track when modal is hidden
document.getElementById('paymentLinksModal').addEventListener('hidden.bs.modal', function() {
  isModalOpen = false;
});

// Toggle Add Payment Link Card
document.getElementById('addLinkCardHeader').addEventListener('click', function() {
  const cardBody = getElementSafe('addLinkCardBody');
  const toggleIcon = getElementSafe('addLinkToggleIcon');
  
  if (cardBody && toggleIcon) {
    if (cardBody.style.display === 'none') {
      cardBody.style.display = 'block';
      toggleIcon.classList.add('rotated');
    } else {
      cardBody.style.display = 'none';
      toggleIcon.classList.remove('rotated');
    }
  }
});

// Add new payment link form submission
document.getElementById('addPaymentLinkForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    amount: document.getElementById('newAmount').value,
    description: document.getElementById('newDescription').value,
    lipia_link: document.getElementById('newLipiaLink').value
  };

  // Validate amount
  if (formData.amount < 100) {
    showModalAlert('Amount must be at least TSh 100', 'danger');
    return;
  }

  // Validate URL
  if (!formData.lipia_link.startsWith('https://')) {
    showModalAlert('Payment link must be a valid HTTPS URL', 'danger');
    return;
  }

  const addBtn = document.getElementById('addLinkBtn');
  const originalText = addBtn.innerHTML;
  
  try {
    addBtn.disabled = true;
    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';

    const response = await fetch('/payments/admin/links', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    });

    const result = await response.json();

    if (result.success) {
      showModalAlert(result.message, 'success');
      clearModalForm();
      loadPaymentLinks(); // Refresh the list
      
      // Collapse the form after successful submission
      const cardBody = getElementSafe('addLinkCardBody');
      const toggleIcon = getElementSafe('addLinkToggleIcon');
      if (cardBody && toggleIcon) {
        cardBody.style.display = 'none';
        toggleIcon.classList.remove('rotated');
      }
    } else {
      showModalAlert(result.message, 'danger');
    }
  } catch (error) {
    console.error('Error adding payment link:', error);
    showModalAlert('Failed to add payment link. Please try again.', 'danger');
  } finally {
    addBtn.disabled = false;
    addBtn.innerHTML = originalText;
  }
});

// Reset form
document.getElementById('resetFormBtn').addEventListener('click', clearModalForm);

// Refresh button
document.getElementById('refreshLinksBtn').addEventListener('click', function() {
  loadPaymentLinks();
  showModalAlert('Payment links list refreshed', 'info');
});

// Load payment links from server
async function loadPaymentLinks() {
  // Don't load if modal is not open
  if (!isModalOpen) {
    console.log('üîÑ Modal not open, skipping payment links load');
    return;
  }

  try {
    console.log('üîÑ Loading payment links from /payments/admin/links/api');
    
    const response = await fetch('/payments/admin/links/api');
    
    console.log('üì• Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    console.log('üì¶ API response:', result);

    if (result.success && result.links) {
      console.log(`‚úÖ Loaded ${result.links.length} payment links successfully`);
      displayPaymentLinks(result.links);
    } else {
      console.error('‚ùå API returned error:', result.message);
      showModalAlert(`API Error: ${result.message}`, 'danger');
    }
  } catch (error) {
    console.error('‚ùå Error loading payment links:', error);
    showModalAlert(`Failed to load payment links: ${error.message}`, 'danger');
  }
}

// Display payment links in table
function displayPaymentLinks(links) {
  const tbody = getElementSafe('paymentLinksBody');
  const noLinksRow = getElementSafe('noLinksRow');
  const linksCount = getElementSafe('linksCount');

  if (!tbody || !noLinksRow || !linksCount) {
    console.error('‚ùå Required DOM elements not found');
    return;
  }

  if (!links || links.length === 0) {
    console.log('üì≠ No payment links found');
    safeDisplayToggle('noLinksRow', '');
    linksCount.textContent = '0 links';
    return;
  }

  console.log(`üìã Displaying ${links.length} payment links`);
  safeDisplayToggle('noLinksRow', 'none');
  linksCount.textContent = `${links.length} link${links.length !== 1 ? 's' : ''}`;

  tbody.innerHTML = links.map(link => {
    // Ensure all required fields exist with fallbacks
    const linkId = link.id || 'N/A';
    const amount = link.amount || 0;
    const description = link.description || 'No description';
    const isActive = link.is_active !== undefined ? link.is_active : true;
    
    return `
      <tr class="payment-link-row" data-link-id="${linkId}">
        <td class="fw-bold">TSh ${parseInt(amount).toLocaleString()}</td>
        <td>
          <div class="description-text">${description}</div>
        </td>
        <td>
          <span class="badge ${isActive ? 'status-badge-active' : 'status-badge-inactive'}">
            ${isActive ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-sm" onclick="toggleLinkStatus(${linkId}, ${!isActive})"
                    title="${isActive ? 'Deactivate' : 'Activate'}">
              <i class="fas ${isActive ? 'fa-pause' : 'fa-play'}"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteLink(${linkId}, ${amount}, '${description.replace(/'/g, "\\'")}')"
                    title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// Toggle link status (active/inactive)
async function toggleLinkStatus(linkId, newStatus) {
  try {
    const response = await fetch(`/payments/admin/links/${linkId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ is_active: newStatus })
    });

    const result = await response.json();

    if (result.success) {
      showModalAlert(result.message, 'success');
      loadPaymentLinks(); // Refresh the list
    } else {
      showModalAlert(result.message, 'danger');
    }
  } catch (error) {
    console.error('Error updating link status:', error);
    showModalAlert('Failed to update link status', 'danger');
  }
}

// Confirm deletion of a payment link
function confirmDeleteLink(linkId, amount, description) {
  currentDeleteLinkId = linkId;
  
  const detailsDiv = getElementSafe('deleteLinkDetails');
  if (detailsDiv) {
    detailsDiv.innerHTML = `
      <strong>Amount:</strong> TSh ${parseInt(amount).toLocaleString()}<br>
      <strong>Description:</strong> ${description}
    `;
  }
  
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteLinkModal'));
  deleteModal.show();
}

// Delete payment link
document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
  if (!currentDeleteLinkId) return;

  const deleteBtn = document.getElementById('confirmDeleteBtn');
  const originalText = deleteBtn.innerHTML;
  
  try {
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';

    const response = await fetch(`/payments/admin/links/${currentDeleteLinkId}`, {
      method: 'DELETE'
    });

    const result = await response.json();

    if (result.success) {
      showModalAlert(result.message, 'success');
      
      // Close delete modal
      const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteLinkModal'));
      deleteModal.hide();
      
      // Refresh the list
      loadPaymentLinks();
    } else {
      showModalAlert(result.message, 'danger');
    }
  } catch (error) {
    console.error('Error deleting payment link:', error);
    showModalAlert('Failed to delete payment link', 'danger');
  } finally {
    deleteBtn.disabled = false;
    deleteBtn.innerHTML = originalText;
    currentDeleteLinkId = null;
  }
});

// Clear modal form
function clearModalForm() {
  const form = getElementSafe('addPaymentLinkForm');
  if (form) {
    form.reset();
  }
  const amountInput = getElementSafe('newAmount');
  if (amountInput) {
    amountInput.focus();
  }
}

// Show alert in modal
function showModalAlert(message, type) {
  const container = getElementSafe('modalFlashContainer');
  if (!container) {
    console.warn('‚ö†Ô∏è Modal flash container not found');
    return;
  }

  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  container.appendChild(alertDiv);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 5000);
}

// Global functions for onclick handlers
window.refreshPaymentLinks = function() {
  loadPaymentLinks();
  showModalAlert('Payment links list refreshed', 'info');
};

window.toggleLinkStatus = toggleLinkStatus;
window.confirmDeleteLink = confirmDeleteLink;
</script>



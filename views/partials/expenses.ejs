


<div class="cat_partial">
  <h2 id="expensesCategoryModalLabel" class="modal-title">Expenses - Fund Management (<%= timeRange || 'All time' %>)</h2>

  <!-- Include fund summary partial -->
  <%- include('fund_summary') %>

  <div class="category-page">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <br><br>
      <h2>EXPENSES (<%= timeRange || 'All time' %>)</h2>
      <div>
        <a class="btn btn-secondary" href="/funds/expenses/pdf?<%= from ? 'from=' + from : '' %>&<%= to ? 'to=' + to : '' %>" target="_blank">Download PDF</a>
        <button class="btn btn-primary" onclick="window.print()">Print</button>
      </div>
    </div>

    <div style="display:flex; gap:12px; margin-top:8px;">
      <div style="background:#fff; padding:12px; border-radius:8px;">
        <h4>Total EXPENSES Fund</h4> (<%= timeRange || 'All time' %>)
        <div><strong>TSh <%= (expenses?.total || 0).toLocaleString() %></strong></div>
      </div>
      <div style="background:#fff; padding:12px; border-radius:8px;">
        <h4>Used</h4>
        <div><strong>TSh <%= (expenses?.used || 0).toLocaleString() %></strong></div>
      </div>
      <div style="background:#fff; padding:12px; border-radius:8px;">
        <h4>Available Expenses Fund</h4>
        <div><strong>TSh <%= (expenses?.available || 0).toLocaleString() %></strong></div>
      </div>
    </div>

    <!-- empty spacer -->
    <div style="height:12px;"></div>

    <h3>Epenses Transactions (<%= timeRange || 'All time' %>)</h3>
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="border:1px solid #ddd; padding:8px;">TN</th>
          <th style="border:1px solid #ddd; padding:8px;">Member</th>
          <th style="border:1px solid #ddd; padding:8px;">Amount</th>
          <th style="border:1px solid #ddd; padding:8px;">Date</th>
        </tr>
      </thead>
      <tbody>
        <% if (expensesTransactions && expensesTransactions.length) { %>
          <% expensesTransactions.forEach((t, idx) => { %>
            <tr>
              <td style="border:1px solid #eee; padding:8px;">
   <% 
    const index = idx + 1; 
    const requestId = t.id || t.txn_no || index; 
  %>
  TRN <%= index %>-<%= requestId %>
</td>
              <td style="border:1px solid #eee; padding:8px;"><%= t.member_first_name %> <%= t.member_surname %></td>
              <td style="border:1px solid #eee; padding:8px;"><%= (t.amount || 0).toLocaleString() %></td>
              <td style="border:1px solid #eee; padding:8px;"><%= t.date ? new Date(t.date).toDateString() : '' %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="4" style="text-align:center; padding:12px;">No transactions found for the selected time range.</td></tr>
        <% } %>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2" style="padding:8px; text-align:right;"><strong>Total Mariage Transactions (<%= timeRange || 'All time' %>)</strong></td>
          <td style="padding:8px;"><strong>TSh <%= (expensesTransactionsTotal || 0).toLocaleString() %></strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

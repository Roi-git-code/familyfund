
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Update Requests</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/app.css">
   <link rel="stylesheet" href="/css/user_requests.css">

  <style>

    .form-container { margin-top: 20px; }
    .request-tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .tab-btn { padding: 8px 16px; border: 1px solid #007bff; border-radius: 4px; background: white; color: #007bff; cursor: pointer; }
    .tab-btn.active { background: #007bff; color: white; }
    .request-table { display: none; overflow-x: auto; }
    .request-table.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    th, td { padding: 8px 12px; text-align: center; border: 1px solid #dee2e6; }
    th { background: #007bff; color: white; position: sticky; top: 0; z-index: 1; }
    .status-rejected { color: red; font-weight: bold; }
    .status-approved { color: green; font-weight: bold; }
    .status-pending { color: orange; font-weight: bold; }
    .btn-view-profile, .btn-view-fund { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; background: #0d6efd; color: white; }
    .btn-view-profile:hover, .btn-view-fund:hover { background: #0b5ed7; }

    /* Modal Styling */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1050; }
    .modal-overlay.show { display: flex; }
    .modal-content { background: white; border-radius: 8px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 16px; position: relative; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; padding-bottom: 8px; margin-bottom: 12px; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; flex-wrap: wrap; }

    @media (max-width: 576px) {
      th, td { font-size: 12px; padding: 6px 8px; }
      .btn-view-profile, .btn-view-fund { font-size: 12px; padding: 4px 8px; }
    }
  </style>
</head>
<body>
  <%- include('partials/header') %>

<%- include('partials/sidebar', { user: user }) %>
<div class="container-fluid py-3">

  <div class="form-container">
    <h2>My Requests</h2>

    <!-- Tabs -->
    <div class="request-tabs mb-3">
      <button class="tab-btn active" data-table="profile">Profile Updates</button>
      <button class="tab-btn" data-table="fund">Fund Requests</button>
    </div>

    <!-- Profile Update Requests -->
    <div id="profile-table" class="request-table active">
      <% if (updateRequests.length > 0) { %>
        <table class="table table-hover table-striped table-bordered">
          <thead>
            <tr>
              <th>ID</th>
              <th>Submitted</th>
              <th>Fields Updated</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% updateRequests.forEach(request => { 
                let fieldCount = 0;
                try {
                  let uf = request.updated_fields;
                  if (typeof uf === 'string') uf = JSON.parse(uf);
                  if (uf && typeof uf === 'object') fieldCount = Object.keys(uf).length;
                } catch(e) { fieldCount = 0; } %>
              <tr>
                <td>#<%= request.id %></td>
                <td><%= new Date(request.created_at).toLocaleDateString() %></td>
                <td><%= fieldCount %> fields</td>
                <td class="status-<%= request.status.toLowerCase() %>"><%= request.status %></td>
                <td><button class="btn-view-profile" data-id="<%= request.id %>">View Request</button></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p class="no-requests">No profile update requests found.</p>
      <% } %>
    </div>

    <!-- Fund Requests -->
    <div id="fund-table" class="request-table">
      <% if (fundRequests.length > 0) { %>
        <table class="table table-hover table-striped table-bordered">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Submitted</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% fundRequests.forEach(request => { %>
              <tr>
                <td>#<%= request.id %></td>
                <td><%= request.request_type %></td>
                <td>TSh <%= request.amount.toLocaleString() %></td>
                <td><%= new Date(request.created_at).toLocaleDateString() %></td>
                <td class="status-<%= request.status.toLowerCase() %>"><%= request.status %></td>
                <td><button class="btn-view-fund" data-id="<%= request.id %>">View Request</button></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } else { %>
        <p class="no-requests">No fund requests found.</p>
      <% } %>
    </div>
  </div>
</div>

<!-- Request Modal -->
<div id="requestModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="d-flex align-items-center gap-2">
        <img src="/images/logo.png" alt="Logo" style="height:30px;">
        <h3>Request Details</h3>
      </div>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p><strong>Request ID:</strong> <span id="modalRequestId"></span></p>
      <p><strong>Type:</strong> <span id="modalRequestType"></span></p>
      <p><strong>Amount:</strong> <span id="modalAmount"></span></p>
      <p><strong>Submitted:</strong> <span id="modalSubmitted"></span></p>
      <p><strong>Status:</strong> <span id="modalStatus"></span></p>
      <p id="modalRejectReasonWrapper" style="display:none;">
        <strong>Rejection Reason:</strong> <span id="modalRejectReason"></span>
      </p>
      <p><strong>Officer Role:</strong> <span id="modalOfficerRole"></span></p>
      <p><strong>Officer Name:</strong> <span id="modalOfficerName"></span></p>
      <div id="modalExtraFields"></div>
    </div>
    <div class="modal-footer">
      <button id="modalResubmitBtn" class="btn btn-warning" style="display:none;">Resubmit</button>
      <a id="modalDownloadBtn" class="btn btn-primary" target="_blank">Download PDF</a>
      <button class="btn btn-secondary modal-close">Close</button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tables = document.querySelectorAll('.request-table');

  tabButtons.forEach(btn => btn.addEventListener('click', () => {
    tabButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    tables.forEach(t => t.classList.remove('active'));
    document.getElementById(btn.dataset.table + '-table').classList.add('active');
  }));

  function openRequestModal(type, id) {
    fetch(`/requests/${type}/${id}/details`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('modalRequestId').textContent = `#${data.id}`;
        document.getElementById('modalRequestType').textContent = data.request_type || 'Profile Update';
        document.getElementById('modalAmount').textContent = data.amount ? `TSh ${parseFloat(data.amount).toLocaleString()}` : 'N/A';
        document.getElementById('modalSubmitted').textContent = new Date(data.created_at).toLocaleDateString();
        document.getElementById('modalStatus').textContent = data.status;
        document.getElementById('modalOfficerRole').textContent = data.officer_role || 'N/A';
        document.getElementById('modalOfficerName').textContent = data.officer_name || 'N/A';

        if (data.status.toLowerCase() === 'rejected') {
          document.getElementById('modalRejectReasonWrapper').style.display = 'block';
          document.getElementById('modalRejectReason').textContent = data.reason || 'N/A';
          document.getElementById('modalResubmitBtn').style.display = 'inline-block';
        } else {
          document.getElementById('modalRejectReasonWrapper').style.display = 'none';
          document.getElementById('modalResubmitBtn').style.display = 'none';
        }

        const extraFields = document.getElementById('modalExtraFields');
        extraFields.innerHTML = '';
        if (data.updated_fields) {
          const fields = typeof data.updated_fields === 'string' ? JSON.parse(data.updated_fields) : data.updated_fields;
          Object.entries(fields).forEach(([key, value]) => {
            const p = document.createElement('p');
            p.innerHTML = `<strong>${key}:</strong> ${value}`;
            extraFields.appendChild(p);
          });
        }

        document.getElementById('modalDownloadBtn').href = type === 'fund' ? `/fund-requests/download/${id}` : `/user-requests/download/${id}`;

        document.getElementById('modalResubmitBtn').onclick = () => {
          if (confirm('Resubmit this request?')) {
            fetch(`/update-requests/resubmit/${id}`, { method: 'POST' })
              .then(r => r.ok ? location.reload() : alert('Failed to resubmit'));
          }
        };

        document.getElementById('requestModal').classList.add('show');
      }).catch(err => alert('Failed to load request details.'));
  }

  document.querySelectorAll('.btn-view-fund').forEach(btn => btn.addEventListener('click', () => openRequestModal('fund', btn.dataset.id)));
  document.querySelectorAll('.btn-view-profile').forEach(btn => btn.addEventListener('click', () => openRequestModal('profile', btn.dataset.id)));

  document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => {
    document.getElementById('requestModal').classList.remove('show');
  }));


//  Status colorizer
  document.querySelectorAll("td[class^='status-']").forEach(cell => {
    const text = cell.textContent.trim().toLowerCase();
    if (text === "approved") {
      cell.style.color = "green";
      cell.style.fontWeight = "bold";
    } else if (text === "pending") {
      cell.style.color = "orange";
      cell.style.fontWeight = "bold";
    } else if (text === "rejected") {
      cell.style.color = "red";
      cell.style.fontWeight = "bold";
    }
  });
});
</script>
<!-- Password Modal -->
<%- include('partials/change_password_modal') %>
<%- include('partials/footer') %>


<script src="/script/dashboard.js"></script>
<script src="/script/sidebar.js"></script>
<script src="/script/user_requests.js"></script>


</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>User Update Requests</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Unified custom CSS -->
  <link href="/css/app.css" rel="stylesheet">
  <link href="/css/user_requests.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100">

        <!-- Header -->
        <%- include('partials/header') %>

  <!-- Sidebar -->
  <%- include('partials/sidebar', { user: user }) %>

  <div class="container-fluid">
    <div class="row">
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">

        <!-- Pending Requests Notification -->
        <% if (user.role === 'chairman' && pendingRequestsCount > 0) { %>
          <div class="alert alert-warning d-flex justify-content-between align-items-center">
            <span>You have <strong><%= pendingRequestsCount %></strong> pending update request(s).</span>
            <a href="#requestsTable" id="scrollToRequests" class="btn btn-sm btn-outline-dark">View Requests</a>
          </div>
        <% } %>

        <h2 id="requestsTable" class="mb-4">User Profile Update Requests</h2>

        <!-- Requests Table -->
        <div class="card shadow-sm">
          <div class="card-body table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th>User</th>
                  <th>Requested Updates</th>
                  <th>Status</th>
                  <th>Date Submitted</th>
                  <th>Review</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody>
                <% requests.forEach(request => { %>
                  <tr class="request-row" data-request='<%- JSON.stringify(request) %>'>
                    <td><%= request.member_name %></td>
                    <td>
                      <%
                        let fieldCount = 0;
                        try {
                          if (request.updated_fields && typeof request.updated_fields === 'object') {
                            fieldCount = Object.keys(request.updated_fields).length;
                          }
                        } catch (e) { fieldCount = 0; }
                      %>
                      <%= fieldCount %> fields
                    </td>
                    <td>
                      <span class="badge 
                        <% if (request.status === 'Approved') { %> bg-success 
                        <% } else if (request.status === 'Rejected') { %> bg-danger 
                        <% } else { %> bg-warning text-dark <% } %>">
                        <%= request.status %>
                      </span>
                    </td>
                    <td><%= new Date(request.created_at).toLocaleString() %></td>
                    <td>
                      <!-- keep btn-review for JS -->
                      <button class="btn btn-primary btn-sm btn-review w-100" data-id="<%= request.id %>">
                        Review
                      </button>
                    </td>
                    <td>
                      <a class="btn btn-outline-secondary btn-sm w-100"
                        href="/user-requests/download/<%= request.id %>"
                        target="_blank" rel="noopener">
                        Download
                      </a>
                    </td>
                  </tr>
                <% }) %>
                <% if (requests.length === 0) { %>
                  <tr><td colspan="6" class="text-center">No update requests found.</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- âœ… Custom Modal (kept same IDs/classes so your JS still works) -->
  <div id="requestModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header d-flex justify-content-between align-items-center">
        <h5>Update Request #<span id="requestId"></span></h5>
        <button class="modal-close">&times;</button>
      </div>

      <div class="modal-body">
        <div class="request-info mb-3">
          <p><strong>User:</strong> <span id="userName"></span></p>
          <p><strong>Submitted:</strong> <span id="submittedDate"></span></p>
          <p><strong>Status:</strong> <span id="requestStatus"></span></p>
        </div>

        <h6>Requested Changes:</h6>
        <div class="table-responsive mb-3">
          <table class="table table-bordered changes-table">
            <thead class="table-light">
              <tr>
                <th>Field</th>
                <th>Current Value</th>
                <th>Requested Value</th>
              </tr>
            </thead>
            <tbody id="changesBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>

        <div id="rejectReasonContainer" style="display:none;">
          <label for="rejectReason" class="form-label"><strong>Reason for Rejection:</strong></label>
          <textarea id="rejectReason" class="form-control" rows="3" placeholder="Explain why this request is being rejected..."></textarea>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-end">
        <button class="btn btn-success btn-approve">Approve</button>
        <button class="btn btn-danger btn-reject">Reject</button>
        <button class="btn btn-outline-danger btn-confirm-reject" style="display:none;">Confirm Rejection</button>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <%- include('partials/change_password_modal') %>
  <%- include('partials/footer') %>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/script/dashboard.js"></script>
  <script src="/script/sidebar.js"></script>
  <script src="/script/user_requests.js"></script>
</body>
</html>

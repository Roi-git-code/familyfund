<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OMA Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">

  <%- include('partials/oma-header', { omaUser: omaUser }) %>
  <div class="d-flex">
    <%- include('partials/oma-sidebar', { active: 'admin', omaUser: omaUser, user: user }) %>

  <div class="container py-4">
    <h3>Online Member Applications</h3>

    <% if (flash.success && flash.success.length) { %>
      <div class="alert alert-success"><%= flash.success[0] %></div>
    <% } %>
    <% if (flash.error && flash.error.length) { %>
      <div class="alert alert-danger"><%= flash.error[0] %></div>
    <% } %>

    <table class="table table-bordered">
      <thead>
        <tr><th>ID</th><th>Name</th><th>Phone</th><th>Email</th><th>Status</th><th>Review</th></tr>
      </thead>
      <tbody>
        <% apps.forEach(app => { %>
          <tr>
            <td><%= app.id %></td>
            <td><%= app.first_name %> <%= app.middle_name %> <%= app.sur_name %></td>
            <td><%= app.phone %></td>
            <td><%= app.email %></td>
            <td><%= app.status %></td>
            <td>
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#reviewModal"
                data-id="<%= app.id %>"
                data-name="<%= app.first_name+' '+(app.middle_name||'')+' '+app.sur_name %>"
                data-email="<%= app.email %>"
                data-phone="<%= app.phone %>"
                data-address="<%= app.address %>"
                data-dob="<%= app.date_of_birth %>"
                data-status="<%= app.status %>"
              >Review</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="reviewForm" method="POST" action="/oma/admin/action/0">
          <div class="modal-header">
            <h5 class="modal-title">Review Application <span id="modalAppId"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <dl class="row">
              <dt class="col-sm-3">Name</dt><dd class="col-sm-9" id="modalName"></dd>
              <dt class="col-sm-3">Email</dt><dd class="col-sm-9" id="modalEmail"></dd>
              <dt class="col-sm-3">Phone</dt><dd class="col-sm-9" id="modalPhone"></dd>
              <dt class="col-sm-3">Address</dt><dd class="col-sm-9" id="modalAddress"></dd>
              <dt class="col-sm-3">DOB</dt><dd class="col-sm-9" id="modalDob"></dd>
              <dt class="col-sm-3">Current Status</dt><dd class="col-sm-9" id="modalStatus"></dd>
            </dl>

            <div id="reviewActions" class="mt-3">
              <div class="mb-2">
                <button name="action" value="approve" class="btn btn-success">Approve</button>
                <button name="action" value="register" class="btn btn-primary">Register</button>
              </div>

              <div class="mb-2">
                <label>Reject reason (if rejecting)</label>
                <textarea name="reason" class="form-control" rows="3"></textarea>
                <div class="mt-2">
                  <button name="action" value="reject" class="btn btn-danger">Reject</button>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" data-bs-dismiss="modal" class="btn btn-secondary">Close</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include('partials/oma-footer') %>
  <!-- bootstrap js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const reviewModal = document.getElementById('reviewModal');
    reviewModal.addEventListener('show.bs.modal', (event) => {
      const button = event.relatedTarget;
      const id = button.dataset.id;
      const name = button.dataset.name;
      const email = button.dataset.email;
      const phone = button.dataset.phone;
      const address = button.dataset.address;
      const dob = button.dataset.dob;
      const status = button.dataset.status;

      document.getElementById('modalAppId').textContent = id;
      document.getElementById('modalName').textContent = name;
      document.getElementById('modalEmail').textContent = email;
      document.getElementById('modalPhone').textContent = phone;
      document.getElementById('modalAddress').textContent = address;
      document.getElementById('modalDob').textContent = dob;
      document.getElementById('modalStatus').textContent = status;

      const form = document.getElementById('reviewForm');
      form.action = '/oma/admin/action/' + id;
    });
  </script>
</body>
</html>

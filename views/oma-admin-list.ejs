

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>OMA Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/flash.css">

  <style>
    :root {
      --primary-purple: #8B5FBF;
      --light-purple: #9D7FCC;
      --gradient-purple: linear-gradient(135deg, #8B5FBF 0%, #6A4C93 100%);
      --light-gradient: linear-gradient(135deg, #f8f4ff 0%, #e8e2ff 100%);
    }
    
    .bg-purple-gradient {
      background: var(--gradient-purple);
    }
    
    .bg-light-purple {
      background: var(--light-gradient);
    }
    
    .kin-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .profile-detail-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }
    
    .profile-detail-item:last-child {
      border-bottom: none;
    }
    
    .detail-label {
      font-weight: 600;
      color: #495057;
      min-width: 140px;
    }
    
    .detail-value {
      color: #212529;
    }
    
    .modal-lg {
      max-width: 900px;
    }
    
    .status-badge {
      font-size: 0.75rem;
    }
    
    .table-hover tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .action-buttons {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      margin-top: 1rem;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .table-responsive {
        font-size: 0.875rem;
      }
      
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.775rem;
      }
      
      .card-body {
        padding: 1rem;
      }
      
      .modal-lg {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
      }
    }
    
    @media (max-width: 576px) {
      .container-fluid {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      
      .card-header h3 {
        font-size: 1.25rem;
      }
      
      .table th,
      .table td {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="bg-light-purple">

  <%- include('partials/oma-header', { omaUser: omaUser }) %>
  
  <div class="d-flex flex-column flex-md-row min-vh-100">
    <%- include('partials/oma-sidebar', { active: 'admin', omaUser: omaUser, user: user }) %>

    <div class="container-fluid py-3 py-md-4 flex-grow-1">
      <div class="card shadow-lg border-0">
        <div class="card-header bg-purple-gradient text-white">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <h3 class="mb-2 mb-md-0"><i class="fas fa-tasks me-2"></i>Online Member Applications</h3>
            <small class="text-white-50">Total: <%= apps ? apps.length : 0 %> applications</small>
          </div>
        </div>
        
        <div class="card-body bg-white">
         <%- include('partials/flash') %>

          <% if (apps && apps.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-hover table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th class="d-none d-md-table-cell">Phone</th>
                    <th class="d-none d-lg-table-cell">Email</th>
                    <th class="d-none d-sm-table-cell">Gender</th>
                    <th>Status</th>
                    <th class="d-none d-md-table-cell">Submitted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% apps.forEach(app => { %>
                    <tr>
                      <td><strong>#<%= app.id %></strong></td>
                      <td>
                        <div class="d-flex flex-column">
                          <span class="fw-bold"><%= app.first_name %> <%= app.sur_name %></span>
                          <% if (app.middle_name) { %>
                            <small class="text-muted"><%= app.middle_name %></small>
                          <% } %>
                        </div>
                      </td>
                      <td class="d-none d-md-table-cell"><%= app.phone %></td>
                      <td class="d-none d-lg-table-cell"><%= app.email %></td>
                      <td class="d-none d-sm-table-cell"><%= app.gender || 'N/A' %></td>
                      <td>
                        <span class="badge 
                          <%= app.status === 'Approved' ? 'bg-success' : 
                              app.status === 'Rejected' ? 'bg-danger' : 
                              app.status === 'Registered' ? 'bg-primary' : 
                              'bg-warning text-dark' %> status-badge">
                          <%= app.status || 'Pending' %>
                        </span>
                      </td>
                      <td class="d-none d-md-table-cell"><%= new Date(app.created_at).toLocaleDateString() %></td>
                      <td>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-purple btn-sm" data-bs-toggle="modal" data-bs-target="#reviewModal"
                            data-id="<%= app.id %>"
                            data-first-name="<%= app.first_name %>"
                            data-middle-name="<%= app.middle_name || '' %>"
                            data-sur-name="<%= app.sur_name %>"
                            data-email="<%= app.email %>"
                            data-phone="<%= app.phone %>"
                            data-address="<%= app.address %>"
                            data-dob="<%= app.date_of_birth %>"
                            data-gender="<%= app.gender || 'N/A' %>"
                            data-marital-status="<%= app.marital_status || 'N/A' %>"
                            data-number-of-children="<%= app.number_of_children || 0 %>"
                            data-father-alive="<%= app.father_alive ? 'Yes' : 'No' %>"
                            data-mother-alive="<%= app.mother_alive ? 'Yes' : 'No' %>"
                            data-status="<%= app.status %>"
                            data-created-at="<%= new Date(app.created_at).toLocaleString() %>"
                            data-updated-at="<%= new Date(app.updated_at).toLocaleString() %>"
                            data-reviewer-note="<%= app.reviewer_note || 'No notes' %>"
                          >
                            <i class="fas fa-eye"></i>
                            <span class="d-none d-sm-inline">Review</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
              <h4 class="text-muted">No Applications Found</h4>
              <p class="text-muted">There are no pending member applications at this time.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="reviewForm" method="POST" action="/oma/admin/action/0">
        <input type="hidden" name="action" id="formAction" value="">
        
        <div class="modal-header bg-purple-gradient text-white">
          <h5 class="modal-title">
            <i class="fas fa-clipboard-check me-2"></i>
            Review Application <span id="modalAppId"></span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
          <!-- Application content remains the same -->
          <div class="row mb-4">
            <div class="col-12 col-md-6">
              <div class="card h-100">
                <div class="card-header bg-light-purple">
                  <h6 class="mb-0"><i class="fas fa-user me-2 text-purple"></i>Personal Information</h6>
                </div>
                <div class="card-body">
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Full Name:</span>
                    <span class="detail-value" id="modalFullName"></span>
                  </div>
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Date of Birth:</span>
                    <span class="detail-value" id="modalDob"></span>
                  </div>
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Gender:</span>
                    <span class="detail-value" id="modalGender"></span>
                  </div>
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Marital Status:</span>
                    <span class="detail-value" id="modalMaritalStatus"></span>
                  </div>
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Children:</span>
                    <span class="detail-value" id="modalNumberOfChildren"></span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-12 col-md-6 mt-3 mt-md-0">
              <div class="card h-100">
                <div class="card-header bg-light-purple">
                  <h6 class="mb-0"><i class="fas fa-address-card me-2 text-purple"></i>Contact Information</h6>
                </div>
                <div class="card-body">
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value" id="modalEmail"></span>
                  </div>
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value" id="modalPhone"></span>
                  </div>
                  <div class="profile-detail-item d-flex flex-column flex-sm-row">
                    <span class="detail-label">Address:</span>
                    <span class="detail-value" id="modalAddress"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Rest of modal content remains the same but with responsive classes -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-light-purple">
                  <h6 class="mb-0"><i class="fas fa-users me-2 text-purple"></i>Family Background</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-12 col-md-6">
                      <div class="profile-detail-item d-flex flex-column flex-sm-row">
                        <span class="detail-label">Father Alive:</span>
                        <span class="detail-value" id="modalFatherAlive"></span>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="profile-detail-item d-flex flex-column flex-sm-row">
                        <span class="detail-label">Mother Alive:</span>
                        <span class="detail-value" id="modalMotherAlive"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Next of Kin Information -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-light-purple">
                  <h6 class="mb-0"><i class="fas fa-user-friends me-2 text-purple"></i>Next of Kin Information</h6>
                </div>
                <div class="card-body" id="modalNextOfKin">
                  <div class="text-center">
                    <div class="spinner-border text-purple" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading next of kin information...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Application Status -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-light-purple">
                  <h6 class="mb-0"><i class="fas fa-info-circle me-2 text-purple"></i>Application Status</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-12 col-md-6">
                      <div class="profile-detail-item d-flex flex-column flex-sm-row">
                        <span class="detail-label">Current Status:</span>
                        <span class="detail-value" id="modalStatus"></span>
                      </div>
                      <div class="profile-detail-item d-flex flex-column flex-sm-row">
                        <span class="detail-label">Submitted:</span>
                        <span class="detail-value" id="modalCreatedAt"></span>
                      </div>
                    </div>
                    <div class="col-12 col-md-6">
                      <div class="profile-detail-item d-flex flex-column flex-sm-row">
                        <span class="detail-label">Last Updated:</span>
                        <span class="detail-value" id="modalUpdatedAt"></span>
                      </div>
                      <div class="profile-detail-item d-flex flex-column flex-sm-row">
                        <span class="detail-label">Reviewer Note:</span>
                        <span class="detail-value" id="modalReviewerNote"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons in Footer -->
        <div class="modal-footer action-buttons">
          <div class="w-100">
            <div class="row g-2">
              <div class="col-12 col-md-4">
                <button type="button" class="btn btn-success w-100" onclick="setAction('approve')">
                  <i class="fas fa-check me-1"></i><span class="d-none d-sm-inline">Approve</span>
                </button>
              </div>
              <div class="col-12 col-md-4">
                <button type="button" class="btn btn-purple w-100" onclick="setAction('register')">
                  <i class="fas fa-user-plus me-1"></i><span class="d-none d-sm-inline">Register</span>
                </button>
              </div>
              <div class="col-12 col-md-4">
                <button type="button" class="btn btn-danger w-100" data-bs-toggle="collapse" data-bs-target="#rejectSection">
                  <i class="fas fa-times me-1"></i><span class="d-none d-sm-inline">Reject</span>
                </button>
              </div>
            </div>

            <!-- Reject Reason Section -->
            <div class="collapse mt-3" id="rejectSection">
              <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                  <h6 class="mb-0">Rejection Reason</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Please provide a reason for rejection:</label>
                    <textarea name="reason" class="form-control" rows="3" placeholder="Enter rejection reason..." required></textarea>
                  </div>
                  <div class="text-end">
                    <button type="button" class="btn btn-danger" onclick="confirmReject()">
                      <i class="fas fa-ban me-1"></i>Confirm Rejection
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Close Button -->
          <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Close
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/oma-footer') %>

  <script src="/js/flash.js"></script>

  <!-- bootstrap js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Font Awesome -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
  // Add purple button styling
  document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
      .btn-purple {
        background: var(--gradient-purple);
        border-color: var(--primary-purple);
        color: white;
      }
      .btn-purple:hover {
        background: var(--primary-purple);
        border-color: var(--light-purple);
        color: white;
      }
      .text-purple {
        color: var(--primary-purple) !important;
      }
    `;
    document.head.appendChild(style);
  });

  // Rest of your existing JavaScript remains the same
  const reviewModal = document.getElementById('reviewModal');
  let currentApplicationId = null;

  reviewModal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    currentApplicationId = id;
    
    console.log('Loading modal data for application:', id);
    
    // Update all fields with data from the button
    document.getElementById('modalAppId').textContent = '#' + id;
    document.getElementById('modalFullName').textContent = 
      button.getAttribute('data-first-name') + ' ' + 
      (button.getAttribute('data-middle-name') || '') + ' ' + 
      button.getAttribute('data-sur-name');
    
    document.getElementById('modalEmail').textContent = button.getAttribute('data-email');
    document.getElementById('modalPhone').textContent = button.getAttribute('data-phone');
    document.getElementById('modalAddress').textContent = button.getAttribute('data-address');
    
    // Format date
    const dob = new Date(button.getAttribute('data-dob'));
    document.getElementById('modalDob').textContent = dob.toLocaleDateString();
    
    document.getElementById('modalGender').textContent = button.getAttribute('data-gender');
    document.getElementById('modalMaritalStatus').textContent = button.getAttribute('data-marital-status');
    document.getElementById('modalNumberOfChildren').textContent = button.getAttribute('data-number-of-children');
    document.getElementById('modalFatherAlive').textContent = button.getAttribute('data-father-alive');
    document.getElementById('modalMotherAlive').textContent = button.getAttribute('data-mother-alive');
    document.getElementById('modalStatus').textContent = button.getAttribute('data-status');
    
    // Format dates
    const createdAt = new Date(button.getAttribute('data-created-at'));
    const updatedAt = new Date(button.getAttribute('data-updated-at'));
    document.getElementById('modalCreatedAt').textContent = createdAt.toLocaleString();
    document.getElementById('modalUpdatedAt').textContent = updatedAt.toLocaleString();
    
    document.getElementById('modalReviewerNote').textContent = button.getAttribute('data-reviewer-note') || 'No notes';

    // Update form action
    const reviewForm = document.getElementById('reviewForm');
    reviewForm.action = '/oma/admin/action/' + id;
    
    console.log('Modal data loaded for:', button.getAttribute('data-first-name'), button.getAttribute('data-sur-name'));
    
    // Load next of kin
    loadNextOfKinInfo(id);
    
    // Reset reject section
    const rejectSection = document.getElementById('rejectSection');
    if (rejectSection.classList.contains('show')) {
      const bsCollapse = new bootstrap.Collapse(rejectSection);
      bsCollapse.hide();
    }
    
    // Clear any previous rejection reason and action
    document.querySelector('textarea[name="reason"]').value = '';
    document.getElementById('formAction').value = '';
  });

  // Load next of kin
  async function loadNextOfKinInfo(applicationId) {
    const nextOfKinContainer = document.getElementById('modalNextOfKin');
    
    try {
      const response = await fetch('/oma/admin/application/' + applicationId + '/next-of-kin');
      const kins = await response.json();
      
      if (kins && kins.length > 0) {
        let html = '';
        kins.forEach(kin => {
          html += `
            <div class="kin-card">
              <div class="row">
                <div class="col-12 col-md-6">
                  <div class="profile-detail-item">
                    <strong>Name:</strong> ${kin.first_name} ${kin.middle_name || ''} ${kin.sur_name}
                  </div>
                  <div class="profile-detail-item">
                    <strong>Relationship:</strong> ${kin.relationship}
                  </div>
                  <div class="profile-detail-item">
                    <strong>Gender:</strong> ${kin.gender}
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="profile-detail-item">
                    <strong>Phone:</strong> ${kin.phone}
                  </div>
                  <div class="profile-detail-item">
                    <strong>Email:</strong> ${kin.email || 'N/A'}
                  </div>
                  <div class="profile-detail-item">
                    <strong>Address:</strong> ${kin.address}
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        nextOfKinContainer.innerHTML = html;
      } else {
        nextOfKinContainer.innerHTML = `
          <div class="text-center py-3">
            <i class="fas fa-users fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">No next of kin information provided</p>
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading next of kin:', error);
      nextOfKinContainer.innerHTML = `
        <div class="alert alert-danger text-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Failed to load next of kin information
        </div>
      `;
    }
  }

  // Simple action functions
  function setAction(action) {
    console.log('Setting action:', action);
    document.getElementById('formAction').value = action;
    document.getElementById('reviewForm').submit();
  }

  function confirmReject() {
    const reason = document.querySelector('textarea[name="reason"]').value.trim();
    
    if (!reason) {
      alert('Please provide a rejection reason.');
      document.querySelector('textarea[name="reason"]').focus();
      return false;
    }
    
    console.log('Confirming reject with reason:', reason);
    document.getElementById('formAction').value = 'reject';
    document.getElementById('reviewForm').submit();
  }
</script>
</body>
</html>




<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Make Payment - FamilyFund</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="/css/flash.css">
  
  <style>
    .payment-method-card {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
      height: 100%;
    }
    .payment-method-card:hover {
      border-color: #007bff;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
    }
    .payment-method-card.selected {
      border-color: #007bff;
      background-color: #f8f9fa;
      box-shadow: 0 2px 10px rgba(0, 123, 255, 0.15);
    }
    .payment-icon { font-size: 2.5rem; margin-bottom: 15px; }
    .amount-input { font-size: 1.2rem; font-weight: 500; }
    .payment-stats {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
    }
    .transaction-history { max-height: 400px; overflow-y: auto; }
    
    /* Payment Form Card - Hidden by default */
    .payment-form-card {
      display: none;
      transition: all 0.3s ease-in-out;
    }
    .payment-form-card.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }
    
    /* Toggle button styles */
    .payment-toggle-btn {
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    
    .payment-toggle-btn .fa-chevron-down {
      transition: transform 0.3s ease;
    }
    
    .payment-toggle-btn.collapsed .fa-chevron-down {
      transform: rotate(-90deg);
    }
    
    /* Dropdown styles */
    .amount-dropdown {
      position: relative;
    }
    .dropdown-menu {
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
    }
    .dropdown-item {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
    }
    .dropdown-item:hover {
      background-color: #f8f9fa;
    }
    .dropdown-item:active {
      background-color: #007bff;
      color: white;
    }
    .amount-suggestion {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .quick-amount-badge {
      font-size: 0.75rem;
      margin-left: 8px;
    }
    
    /* Custom amount highlight */
    .custom-amount-highlight {
      border-left: 4px solid #28a745;
      background-color: #f8fff9;
    }
    
    /* Animation for payment form */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive button group styles */
    .desktop-btn-group {
      display: flex;
    }
    .mobile-btn-group {
      display: none;
      width: 100%;
    }
    .mobile-btn-group .btn-group {
      width: 100%;
    }
    .mobile-btn-group .btn {
      flex: 1;
    }

    @media (max-width: 768px) {
      .desktop-btn-group {
        display: none;
      }
      .mobile-btn-group {
        display: block;
        margin-top: 1rem;
      }
      .page-header-mobile {
        text-align: center;
      }
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Header -->
  <%- include('../partials/header') %>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <%- include('../partials/sidebar'  , { user: user } ) %>
      </nav>

      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <!-- Page Header with Responsive Button Groups -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-md-row flex-column">
          <div class="page-header-mobile">
            <h2><i class="fas fa-credit-card me-2"></i>Make Payment</h2>
          </div>
          
          <!-- Desktop Button Group (visible on md screens and up) -->
          <div class="desktop-btn-group">
            <div class="btn-group">
              <a href="/payments/history" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-history me-1"></i>Payment History
              </a>
              <% if (['chairman', 'chief_signatory', 'assistant_signatory'].includes(user.role)) { %>
                <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#paymentLinksModal">
                  <i class="fas fa-cog me-1"></i>Manage Payment Links
                </button>
              <% } %>
              <a href="/dashboard" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
              </a>
            </div>
          </div>
        </div>

        <!-- Mobile Button Group (visible on sm screens and down) -->
        <div class="mobile-btn-group">
          <div class="btn-group" role="group">
            <a href="/payments/history" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-history me-1"></i>History
            </a>
            <% if (['chairman', 'chief_signatory', 'assistant_signatory'].includes(user.role)) { %>
              <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#paymentLinksModal">
                <i class="fas fa-cog me-1"></i>Manage Links
              </button>
            <% } %>
            <a href="/dashboard" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-arrow-left me-1"></i>Dashboard
            </a>
          </div>
        </div>

        <!-- Flash Messages -->
       <%- include('../partials/flash') %>

        <div class="row g-4">
          <!-- Payment Form Section -->
          <div class="col-lg-8">
            <!-- Payment Toggle Button -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">
                <i class="fas fa-money-bill-wave me-2 text-primary"></i>Payment Details
              </h5>
              <button type="button" class="btn btn-success payment-toggle-btn" id="paymentToggleBtn">
                <i class="fas fa-plus me-2"></i>
                <span id="paymentToggleText">Make Payment</span>
                <i class="fas fa-chevron-down ms-2"></i>
              </button>
            </div>

            <!-- Payment Form Card (Hidden by Default) -->
            <div class="card shadow-sm mb-4 payment-form-card" id="paymentFormCard">
              <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                  <i class="fas fa-money-bill-wave me-2"></i>Payment Details
                </h5>
              </div>
              <div class="card-body">
                <form id="paymentForm" method="POST" action="/payments/initiate-lipia">
                  
                  <!-- Amount Input with Dropdown -->
                  <div class="row mb-4">
                    <div class="col-12">
                      <label for="amount" class="form-label fw-bold">Payment Amount</label>
                      
                      <div class="amount-dropdown">
                        <div class="input-group">
                          <span class="input-group-text bg-primary text-white">
                            <i class="fas fa-money-bill-wave"></i>
                          </span>
                          <input type="number" 
                                 class="form-control form-control-lg amount-input"
                                 id="amount" 
                                 name="amount" 
                                 min="100" 
                                 step="100" 
                                 required 
                                 placeholder="Enter amount or select from list"
                                 autocomplete="off">
                          <button class="btn btn-outline-secondary dropdown-toggle" 
                                  type="button" 
                                  data-bs-toggle="dropdown" 
                                  aria-expanded="false"
                                  id="amountDropdownButton">
                            <i class="fas fa-list"></i>
                          </button>
                          
                          <!-- Dropdown Menu -->
                          <ul class="dropdown-menu dropdown-menu-end" id="amountDropdown">
                            <li><h6 class="dropdown-header">Quick Select Amounts</h6></li>
                            <div id="amountList">
                              <% if (availableAmounts && availableAmounts.length > 0) { %>
                                <% availableAmounts.forEach(amountObj => { %>
                                  <li>
                                    <a class="dropdown-item amount-option" 
                                       data-amount="<%= amountObj.amount %>"
                                       href="javascript:void(0)">
                                      <div class="d-flex justify-content-between align-items-center">
                                        <span>
                                          <strong>TSh <%= Number(amountObj.amount).toLocaleString() %></strong>
                                        </span>
                                        <span class="badge bg-primary quick-amount-badge">Quick</span>
                                      </div>
                                      <small class="amount-suggestion"><%= amountObj.description %></small>
                                    </a>
                                  </li>
                                <% }) %>
                              <% } else { %>
                                <!-- Fallback amounts -->
                                <li><a class="dropdown-item amount-option" data-amount="1000" href="javascript:void(0)">TSh 1,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="5000" href="javascript:void(0)">TSh 5,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="10000" href="javascript:void(0)">TSh 10,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="20000" href="javascript:void(0)">TSh 20,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="25000" href="javascript:void(0)">TSh 25,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="50000" href="javascript:void(0)">TSh 50,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="100000" href="javascript:void(0)">TSh 100,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="500000" href="javascript:void(0)">TSh 500,000</a></li>
                                <li><a class="dropdown-item amount-option" data-amount="1000000" href="javascript:void(0)">TSh 1,000,000</a></li>
                              <% } %>
                            </div>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <a class="dropdown-item text-muted" href="javascript:void(0)">
                                <small><i class="fas fa-info-circle me-1"></i>Type to filter amounts</small>
                              </a>
                            </li>
                          </ul>
                        </div>
                        
                        <!-- Help text -->
                        <div class="form-text mt-2">
                          <i class="fas fa-lightbulb me-1 text-warning"></i>
                          <strong>Tip:</strong> Start typing to filter amounts or click the list icon to see all options
                        </div>
                        
                        <!-- Amount Type Indicator -->
                        <div class="mt-2">
                          <small class="badge" id="amountTypeBadge">
                            <i class="fas fa-keyboard me-1"></i>Custom amount
                          </small>
                          <small class="text-muted ms-2" id="amountMatchText"></small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Phone Number -->
                  <div class="row mb-4">
                    <div class="col-12">
                      <label for="phone_number" class="form-label fw-bold">Mobile Money Phone Number</label>
                      <div class="input-group">
                        <span class="input-group-text bg-light">
                          <i class="fas fa-mobile-alt"></i>
                        </span>
                        <input type="tel" 
                               class="form-control" 
                               id="phone_number" 
                               name="phone_number"
                               required 
                               placeholder="712345678"
                               pattern="[0-9]{9}"
                               maxlength="9">
                      </div>
                      <div class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Enter your 9-digit phone number (without +255 or 0)
                      </div>
                    </div>
                  </div>

<!-- Add this section after the Phone Number input -->
<div class="row mb-4">
  <div class="col-12">
    <label for="payment_type" class="form-label fw-bold">Payment Type</label>
    <div class="input-group">
      <span class="input-group-text bg-light">
        <i class="fas fa-tag"></i>
      </span>
      <select class="form-select" id="payment_type" name="payment_type" required>
        <option value="Contribution" selected>Contribution</option>
        <option value="ROI">Return on Investment (ROI)</option>
        <option value="Refund">Refund</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-text text-muted">
      <i class="fas fa-info-circle me-1"></i>
      Select the purpose of this payment. This determines how it will be recorded.
    </div>
  </div>
</div>

<!-- Add dynamic fields based on payment type -->
<div id="paymentTypeFields" style="display: none;">
  <!-- ROI Fields -->
  <div class="row mb-3 roi-fields" style="display: none;">
    <div class="col-md-6">
      <label for="roi_percentage" class="form-label">ROI Percentage</label>
      <input type="number" class="form-control" id="roi_percentage" name="roi_percentage" 
             min="1" max="100" step="0.01" value="10">
    </div>
    <div class="col-md-6">
      <label for="period_start" class="form-label">Period Start</label>
      <input type="date" class="form-control" id="period_start" name="period_start">
    </div>
  </div>
  
  <!-- Refund Fields -->
  <div class="row mb-3 refund-fields" style="display: none;">
    <div class="col-12">
      <label for="reason" class="form-label">Refund Reason</label>
      <textarea class="form-control" id="reason" name="reason" rows="2" 
                placeholder="Enter reason for refund"></textarea>
    </div>
  </div>
</div>
                                
                  <!-- Payment Method Selection -->
                  <div class="row mb-4">
                    <div class="col-12">
                      <label class="form-label fw-bold">Payment Method</label>
                      <div class="row g-3 justify-content-center">
                        <!-- Azam Lipia Link Only -->
                        <div class="col-md-6">
                          <div class="payment-method-card p-4 text-center selected">
                            <div class="payment-icon">
                              <i class="fab fa-cc-amazon-pay" style="font-size:2.5rem;color:#0d6efd;"></i>
                            </div>
                            <h6 class="fw-bold">Azam Lipia</h6>
                            <small class="text-muted">Secure payment via Azam Lipia</small>
                            <div class="mt-2">
                              <span class="badge bg-success">Recommended</span>
                            </div>
                            <div class="mt-3">
                              <small class="text-success">
                                <i class="fas fa-shield-alt me-1"></i>100% Secure
                              </small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Selected Amount Display -->
                  <div class="row mb-3">
                    <div class="col-12">
                      <div class="alert alert-info" id="amountSummary">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <h6 class="mb-1">Ready to Pay</h6>
                            <p class="mb-0 fs-5 fw-bold">TSh <span id="displayAmount">0</span></p>
                            <small class="text-muted" id="amountDescription">Select or enter an amount to continue</small>
                          </div>
                          <div class="text-end">
                            <small id="linkType" class="badge bg-secondary">No amount selected</small>
                            <div id="exactMatch" class="mt-1" style="display: none;">
                              <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i>Exact match
                              </small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Submit Button -->
                  <div class="row">
                    <div class="col-12">
                      <button type="submit" class="btn btn-primary btn-lg w-100 py-3" id="payButton" disabled>
                        <i class="fas fa-lock me-2"></i>Secure Payment - TSh <span id="submitAmount">0</span>
                      </button>
                    </div>
                  </div>

                </form>
              </div>
            </div>
          </div>

          <!-- Sidebar Stats & History (ALWAYS VISIBLE) -->
          <div class="col-lg-4">
            <!-- Payment Statistics -->
            <div class="card shadow-sm mb-4">
              <div class="card-body payment-stats text-center">
                <h6 class="text-white-50">Total Contributions</h6>
                <h3 class="text-white fw-bold">TSh <%= totalContributions ? Number(totalContributions).toLocaleString() : '0' %></h3>
                <p class="text-white-50 mb-0">This Month</p>
              </div>
            </div>

            <!-- Recent Payments -->
            <div class="card shadow-sm">
              <div class="card-header bg-secondary text-white">
                <h6 class="card-title mb-0">
                  <i class="fas fa-clock me-2"></i>Recent Payments
                </h6>
              </div>
              <div class="card-body">
                <% if (payments && payments.length > 0) { %>
                  <div class="transaction-history">
                    <div class="list-group list-group-flush">
                      <% payments.slice(0, 6).forEach(payment => { %>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                          <div>
                            <small class="text-muted d-block">
                              <%= new Date(payment.created_at).toLocaleDateString() %>
                            </small>
                            <div class="fw-bold">TSh <%= Number(payment.amount).toLocaleString() %></div>
                            <small class="text-muted">Azam Lipia</small>
                          </div>
                          <span class="badge
                              <%= payment.status === 'Paid' ? 'bg-success' :
                                  payment.status === 'Pending' ? 'bg-warning' :
                                  'bg-danger' %>">
                            <%= payment.status %>
                          </span>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                  <% if (payments.length > 0) { %>
                    <div class="text-center mt-3">
                      <a href="/payments/history" class="btn btn-sm btn-outline-primary">View All Payments</a>
                    </div>
                  <% } %>
                <% } else { %>
                  <div class="text-center py-4">
                    <i class="fas fa-receipt fa-2x text-muted mb-3"></i>
                    <p class="text-muted mb-0">No payment history yet</p>
                    <small class="text-muted">Your payments will appear here</small>
                  </div>
                <% } %>
              </div>
            </div>

            <!-- Support Info -->
            <div class="card shadow-sm mt-4">
              <div class="card-body text-center">
                <i class="fas fa-headset fa-2x text-primary mb-3"></i>
                <h6>Need Help?</h6>
                <p class="small text-muted mb-2">Having issues with payments?</p>
                <a href="/support" class="btn btn-outline-primary btn-sm">Contact Support</a>
              </div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Footer -->
  <%- include('../partials/footer') %>
  <!-- Password Modal -->
  <%- include('../partials/change_password_modal') %>

<!-- Payment Links Management Modal -->
<% if (['chairman', 'chief_signatory', 'assistant_signatory'].includes(user.role)) { %>
  <%- include('../partials/payment-links-modal') %>
<% } %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Payment Toggle Functionality - Only affects the payment form card
  const paymentToggleBtn = document.getElementById('paymentToggleBtn');
  const paymentFormCard = document.getElementById('paymentFormCard');
  const paymentToggleText = document.getElementById('paymentToggleText');

  paymentToggleBtn.addEventListener('click', function() {
    const isVisible = paymentFormCard.classList.contains('show');
    
    if (isVisible) {
      paymentFormCard.classList.remove('show');
      paymentToggleText.textContent = 'Make Payment';
      paymentToggleBtn.classList.remove('btn-secondary');
      paymentToggleBtn.classList.add('btn-success');
      paymentToggleBtn.classList.add('collapsed');
    } else {
      paymentFormCard.classList.add('show');
      paymentToggleText.textContent = 'Done';
      paymentToggleBtn.classList.remove('btn-success');
      paymentToggleBtn.classList.add('btn-secondary');
      paymentToggleBtn.classList.remove('collapsed');
    }
  });

  // Existing payment form functionality (unchanged)
  const amountInput = document.getElementById('amount');
  const displayAmount = document.getElementById('displayAmount');
  const submitAmount = document.getElementById('submitAmount');
  const amountDescription = document.getElementById('amountDescription');
  const payButton = document.getElementById('payButton');
  const phoneInput = document.getElementById('phone_number');
  const amountDropdown = document.getElementById('amountDropdown');
  const amountList = document.getElementById('amountList');
  const amountTypeBadge = document.getElementById('amountTypeBadge');
  const amountMatchText = document.getElementById('amountMatchText');
  const linkType = document.getElementById('linkType');
  const exactMatch = document.getElementById('exactMatch');
  const amountSummary = document.getElementById('amountSummary');
  const amountDropdownButton = document.getElementById('amountDropdownButton');

  let selectedAmount = 0;
  let isExactMatch = false;
  let availableAmounts = [];
  let isDropdownOpen = false;

  // Initialize available amounts from dropdown
  function initializeAvailableAmounts() {
    const amountOptions = document.querySelectorAll('.amount-option');
    availableAmounts = Array.from(amountOptions).map(option => ({
      amount: parseInt(option.dataset.amount),
      element: option
    })).sort((a, b) => a.amount - b.amount);
  }

  // Filter amounts based on input
  function filterAmounts(searchValue) {
    const searchNum = parseInt(searchValue) || 0;
    
    availableAmounts.forEach(item => {
      const amountStr = item.amount.toString();
      const displayStr = item.amount.toLocaleString();
      const isMatch = searchNum === 0 || 
                     amountStr.includes(searchValue) || 
                     displayStr.includes(searchValue) ||
                     item.amount === searchNum;
      
      item.element.style.display = isMatch ? 'block' : 'none';
    });
  }

  // Check if current amount matches any predefined amount
  function checkAmountMatch(currentAmount) {
    const amountNum = parseInt(currentAmount);
    if (!amountNum) {
      isExactMatch = false;
      exactMatch.style.display = 'none';
      return;
    }

    const matchedAmount = availableAmounts.find(item => item.amount === amountNum);
    isExactMatch = !!matchedAmount;
    
    if (isExactMatch) {
      exactMatch.style.display = 'block';
      linkType.textContent = 'Quick Select';
      linkType.className = 'badge bg-success';
      amountTypeBadge.innerHTML = '<i class="fas fa-bolt me-1"></i>Quick amount';
      amountTypeBadge.className = 'badge bg-success';
    } else {
      exactMatch.style.display = 'none';
      linkType.textContent = 'Custom amount';
      linkType.className = 'badge bg-warning text-dark';
      amountTypeBadge.innerHTML = '<i class="fas fa-keyboard me-1"></i>Custom amount';
      amountTypeBadge.className = 'badge bg-warning text-dark';
      
      // Find closest amount for suggestion
      const closest = availableAmounts.reduce((prev, curr) => {
        return (Math.abs(curr.amount - amountNum) < Math.abs(prev.amount - amountNum) ? curr : prev);
      });
      
      if (closest) {
        amountMatchText.textContent = `Closest match: TSh ${closest.amount.toLocaleString()}`;
      } else {
        amountMatchText.textContent = '';
      }
    }
  }

  // Update displayed amount and enable/disable pay button
  function updateDisplayAmount(amount) {
    selectedAmount = amount;
    const amountNum = parseInt(amount);
    const formattedAmount = amountNum ? amountNum.toLocaleString() : '0';
    
    displayAmount.textContent = formattedAmount;
    submitAmount.textContent = formattedAmount;
    
    if (amountNum > 0) {
      payButton.disabled = false;
      
      // Update amount description
      if (isExactMatch) {
        amountDescription.textContent = 'Pre-configured payment link available';
        amountDescription.className = 'text-success';
        amountSummary.className = 'alert alert-success';
      } else {
        amountDescription.textContent = 'Will use closest available payment link';
        amountDescription.className = 'text-warning';
        amountSummary.className = 'alert alert-info';
      }
    } else {
      payButton.disabled = true;
      amountDescription.textContent = 'Select or enter an amount to continue';
      amountDescription.className = 'text-muted';
      amountSummary.className = 'alert alert-info';
      linkType.textContent = 'No amount selected';
      linkType.className = 'badge bg-secondary';
    }
    
    checkAmountMatch(amount);
  }

  // Amount option click handler
  function setupAmountOptions() {
    document.querySelectorAll('.amount-option').forEach(option => {
      option.addEventListener('click', function(e) {
        e.preventDefault();
        const amount = this.dataset.amount;
        amountInput.value = amount;
        updateDisplayAmount(amount);
        
        // Close dropdown but keep focus on input
        const dropdown = bootstrap.Dropdown.getInstance(amountDropdownButton);
        if (dropdown) {
          dropdown.hide();
        }
        isDropdownOpen = false;
        
        // Return focus to input field immediately
        setTimeout(() => {
          amountInput.focus();
        }, 100);
        
        // Highlight selected option temporarily
        this.classList.add('active');
        setTimeout(() => this.classList.remove('active'), 1000);
      });
    });
  }

  // Real-time input handling
  amountInput.addEventListener('input', function() {
    const value = this.value;
    updateDisplayAmount(value);
    filterAmounts(value);
    
    // Keep dropdown open while typing
    if (value.length > 0 && !isDropdownOpen) {
      const dropdown = new bootstrap.Dropdown(amountDropdownButton);
      dropdown.show();
      isDropdownOpen = true;
    }
  });

  // Focus handling - don't automatically open dropdown on focus
  amountInput.addEventListener('focus', function() {
    // Only show dropdown if there's content and it's not already open
    if (this.value.length > 0 && !isDropdownOpen) {
      filterAmounts(this.value);
      const dropdown = new bootstrap.Dropdown(amountDropdownButton);
      dropdown.show();
      isDropdownOpen = true;
    }
  });

  // Handle dropdown show/hide events to track state
  amountDropdown.addEventListener('show.bs.dropdown', function() {
    isDropdownOpen = true;
  });

  amountDropdown.addEventListener('hide.bs.dropdown', function() {
    isDropdownOpen = false;
  });

  // Prevent dropdown from closing when clicking inside it
  amountDropdown.addEventListener('click', function(e) {
    e.stopPropagation();
  });

  // Handle dropdown button click - toggle without affecting input focus
  amountDropdownButton.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const dropdown = bootstrap.Dropdown.getInstance(this);
    if (isDropdownOpen) {
      dropdown.hide();
      isDropdownOpen = false;
    } else {
      dropdown.show();
      isDropdownOpen = true;
      // Filter amounts when manually opening dropdown
      filterAmounts(amountInput.value);
    }
    
    // Maintain focus on input field
    setTimeout(() => {
      amountInput.focus();
    }, 50);
  });

  // Auto-format phone number
  phoneInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 9) {
      value = value.substring(0, 9);
    }
    e.target.value = value;
  });

  // Handle clicks outside to close dropdown but keep keyboard open
  document.addEventListener('click', function(e) {
    if (!amountInput.contains(e.target) && !amountDropdown.contains(e.target)) {
      const dropdown = bootstrap.Dropdown.getInstance(amountDropdownButton);
      if (dropdown && isDropdownOpen) {
        dropdown.hide();
        isDropdownOpen = false;
      }
    }
  });

  // Payment Type Change Handler
document.getElementById('payment_type').addEventListener('change', function() {
  const paymentType = this.value;
  const typeFields = document.getElementById('paymentTypeFields');
  const roiFields = document.querySelector('.roi-fields');
  const refundFields = document.querySelector('.refund-fields');
  
  // Hide all fields first
  typeFields.style.display = 'none';
  if (roiFields) roiFields.style.display = 'none';
  if (refundFields) refundFields.style.display = 'none';
  
  // Show relevant fields based on type
  switch(paymentType) {
    case 'ROI':
      typeFields.style.display = 'block';
      if (roiFields) {
        roiFields.style.display = 'flex';
        // Set default dates for ROI
        const today = new Date().toISOString().split('T')[0];
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        const nextMonthStr = nextMonth.toISOString().split('T')[0];
        
        document.getElementById('period_start').value = today;
        document.getElementById('period_end').value = nextMonthStr;
      }
      break;
      
    case 'Refund':
      typeFields.style.display = 'block';
      if (refundFields) refundFields.style.display = 'block';
      break;
      
    default:
      typeFields.style.display = 'none';
  }
  
  // Update amount description based on payment type
  updateAmountDescription(paymentType);
});

function updateAmountDescription(paymentType) {
  const amountInput = document.getElementById('amount');
  const amountDescription = document.getElementById('amountDescription');
  
  if (!amountInput.value) return;
  
  const descriptions = {
    'Contribution': 'Member contribution payment',
    'ROI': 'Return on Investment payment',
    'Refund': 'Refund payment to member',
    'Other': 'Other payment type'
  };
  
  amountDescription.textContent = descriptions[paymentType] || 'Payment';
}

// Initialize payment type on page load
document.addEventListener('DOMContentLoaded', function() {
  const paymentTypeSelect = document.getElementById('payment_type');
  if (paymentTypeSelect) {
    paymentTypeSelect.dispatchEvent(new Event('change'));
  }
  
  // Also trigger when amount changes
  const amountInput = document.getElementById('amount');
  if (amountInput) {
    amountInput.addEventListener('input', function() {
      const paymentType = document.getElementById('payment_type').value;
      updateAmountDescription(paymentType);
    });
  }
});
  
  // Form validation and submission
  const paymentForm = document.getElementById('paymentForm');
  
  paymentForm.addEventListener('submit', function(e) {
    const amount = parseFloat(amountInput.value);
    const phone = phoneInput.value;

    // Validation
    if (!amount || amount < 100) {
      e.preventDefault();
      showAlert('Please enter a valid amount (minimum TSh 100)', 'danger');
      amountInput.focus();
      return;
    }

    if (!phone || phone.length !== 9) {
      e.preventDefault();
      showAlert('Please enter a valid 9-digit phone number', 'danger');
      phoneInput.focus();
      return;
    }

    // Show loading state
    payButton.disabled = true;
    payButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
  });

  function showAlert(message, type) {
    const existingAlerts = document.querySelectorAll(`.alert-${type}`);
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.innerHTML = `
      <i class="fas ${type === 'danger' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const flashContainer = document.getElementById('flashContainer');
    flashContainer.appendChild(alertDiv);
    
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }

  // Initialize
  initializeAvailableAmounts();
  setupAmountOptions();
  updateDisplayAmount(0);
});
</script>


<script src="/script/dashboard.js"></script>
<script src="/script/sidebar.js"></script>
<script src="/script/layoutScript.js"></script>
<script src="/js/flash.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



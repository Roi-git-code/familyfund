



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Financial Statement</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/flash.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .statement-card { 
      background: white; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
      padding: 25px; 
      margin-bottom: 25px; 
      width: 100%;
    }
    h2 { 
      color: #2c3e50; 
      border-bottom: 2px solid #3498db; 
      padding-bottom: 10px; 
    }
    h3 { 
      color: #34495e; 
      margin: 25px 0 15px 0; 
    }
    .month-section { 
      background: #f8f9fa; 
      border-left: 4px solid #3498db; 
      padding: 15px; 
      margin: 20px 0; 
      border-radius: 0 8px 8px 0; 
    }
    .month-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px; 
    }
    .month-title { 
      font-size: 1.3rem; 
      font-weight: 600; 
      color: #2c3e50; 
      margin: 0; 
    }
    .month-summary { 
      background: #e8f4fd; 
      padding: 10px 15px; 
      border-radius: 6px; 
      font-weight: 500; 
    }
    table { 
      background: #fff; 
      font-size: 0.9rem; 
      width: 100% !important;
    }
    th { 
      background: #2c3e50; 
      color: white; 
      font-weight: 600; 
      padding: 12px 8px; 
    }
    td { 
      padding: 10px 8px; 
      vertical-align: middle; 
    }
    .credit { 
      color: #27ae60; 
      font-weight: 600; 
    }
    .debit { 
      color: #e74c3c; 
      font-weight: 600; 
    }
    .balance { 
      font-weight: 700; 
      color: #2c3e50; 
    }
    .transaction-id { 
      font-family: 'Courier New', monospace; 
      font-size: 0.85rem; 
      color: #7f8c8d; 
    }
    .filter-form { 
      background: white; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 1px 5px rgba(0,0,0,0.1); 
      margin-bottom: 25px; 
    }
    .filter-form .form-control, .filter-form .form-select { 
      border: 1px solid #bdc3c7; 
    }
    .filter-form label { 
      font-weight: 500; 
      color: #2c3e50; 
      margin-bottom: 5px; 
    }
    .badge-credit { 
      background: #27ae60; 
    }
    .badge-debit { 
      background: #e74c3c; 
    }
    .summary-card { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      border-radius: 10px; 
      padding: 20px; 
      margin: 15px 0; 
    }
    .summary-value { 
      font-size: 1.8rem; 
      font-weight: 700; 
      margin: 5px 0; 
    }
    .table-hover tbody tr:hover { 
      background-color: rgba(52, 152, 219, 0.1); 
    }
    .closing-balance { 
      background: #2c3e50; 
      color: white; 
      font-weight: 700; 
      font-size: 1.1rem; 
    }
    .financial-statement-page .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: margin-left 0.3s ease;
      width: calc(100% - 250px);
    }
    
    /* Toggle Styles */
    .toggle-header {
      cursor: pointer;
      padding: 15px 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      border: 1px solid #dee2e6;
    }
    .toggle-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      transform: translateY(-1px);
    }
    .toggle-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .toggle-content.show {
      max-height: 1000px;
    }
    .toggle-icon {
      transition: transform 0.3s ease;
    }
    .toggle-icon.rotated {
      transform: rotate(180deg);
    }
    
    /* DataTable Customizations */
    .dataTables_wrapper {
      margin-top: 1rem;
    }
    .dataTables_length select {
      border-radius: 6px;
      padding: 5px;
    }
    .dataTables_filter input {
      border-radius: 6px;
      padding: 5px 10px;
      border: 1px solid #ddd;
    }
    .dataTables_info {
      color: #6c757d;
      padding-top: 0.755em;
    }
    .dataTables_paginate .paginate_button {
      border-radius: 6px !important;
      margin: 0 2px;
    }
    
    /* Pagination for monthly sections */
    .month-pagination {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .financial-statement-page .main-content {
        margin-left: 0;
        width: 100%;
        padding: 15px 10px;
      }
      
      .statement-card {
        padding: 15px;
        margin-bottom: 20px;
      }
      
      .month-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .month-title {
        font-size: 1.1rem;
      }
      
      .month-summary {
        width: 100%;
        text-align: center;
      }
      
      .table-responsive {
        font-size: 0.8rem;
      }
      
      .btn-group {
        flex-wrap: wrap;
        gap: 5px;
      }
      
      .btn-group .btn {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
      }
      
      .summary-value {
        font-size: 1.4rem;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      h3 {
        font-size: 1.3rem;
      }
    }
    
    @media (max-width: 576px) {
      .filter-form .row {
        gap: 10px;
      }
      
      .filter-form .col-md-3 {
        width: 100%;
      }
      
      .d-flex.justify-content-between.align-items-center {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
    }
  </style>
</head>
<body class="financial-statement-page">

 <%- include('partials/header') %>

<%- include('partials/sidebar', { user: user }) %>

<!-- Password Change Modal -->
<%- include('partials/change_password_modal', { user: user }) %>

<div class="main-content">
  <%- include('partials/flash') %>
    
  <div class="container-fluid my-4">
   
    <!-- Page Header with Download Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-file-invoice-dollar me-2"></i>Financial Statement</h2>
      <div class="btn-group">
        <% 
          const isOfficial = user && ['chairman', 'chief_signatory', 'assistant_signatory'].includes(user.role);
          const isMember = user && user.role === 'member';
        %>
        
        <% if (isOfficial) { %>
          <!-- Show all three buttons for officials -->
          <a href="/financial-statement/pdf?type=overall<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-success">
            <i class="fas fa-download me-1"></i>Overall PDF
          </a>
          <a href="/financial-statement/pdf?type=individual<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-success">
            <i class="fas fa-download me-1"></i>Individual PDF
          </a>
          <a href="/financial-statement/pdf<%= pdfQuery ? '?' + pdfQuery : '' %>" class="btn btn-success">
            <i class="fas fa-download me-1"></i>Both PDF
          </a>
        <% } else if (isMember) { %>
          <!-- Show only individual PDF button for regular members -->
          <a href="/financial-statement/pdf?type=individual<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-success">
            <i class="fas fa-download me-1"></i>Download Individual PDF
          </a>
        <% } else { %>
          <!-- Fallback for other roles -->
          <a href="/financial-statement/pdf?type=individual<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-success">
            <i class="fas fa-download me-1"></i>Download PDF
          </a>
        <% } %>
      </div>
    </div>

    <!-- Filter Form Toggle -->
    <div class="card shadow-sm mb-4">
      <div class="toggle-header d-flex justify-content-between align-items-center" id="filterToggleHeader">
        <h5 class="card-title mb-0 text-primary">
          <i class="fas fa-filter me-2"></i>Filter Options
        </h5>
        <i class="fas fa-chevron-down toggle-icon text-primary" id="filterToggleIcon"></i>
      </div>
      <div class="toggle-content" id="filterToggleContent">
        <div class="card-body">
          <div class="filter-form">
            <form method="get" action="/financial-statement" class="row g-3 align-items-end">
              <% if (isOfficial) { %>
                <div class="col-md-3">
                  <label class="form-label">Member</label>
                  <select name="member_id" class="form-select">
                    <option value="">All Members</option>
                    <% membersList.forEach(m => { %>
                      <option value="<%= m.id %>" <%= member_id == m.id ? 'selected' : '' %>>
                        <%= m.first_name %> <%= m.sur_name %>
                      </option>
                    <% }) %>
                  </select>
                </div>
              <% } %>

              <div class="col-md-3">
                <label class="form-label">From Month</label>
                <input type="month" name="from" class="form-control" value="<%= fromInput || '' %>">
              </div>
              <div class="col-md-3">
                <label class="form-label">To Month</label>
                <input type="month" name="to" class="form-control" value="<%= toInput || '' %>">
              </div>

              <div class="col-md-3">
                <button class="btn btn-primary w-100">
                  <i class="fas fa-filter me-1"></i>Apply Filter
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Cards Toggle -->
    <div class="card shadow-sm mb-4">
      <div class="toggle-header d-flex justify-content-between align-items-center" id="statsToggleHeader">
        <h5 class="card-title mb-0 text-primary">
          <i class="fas fa-chart-bar me-2"></i>Financial Summary
        </h5>
        <i class="fas fa-chevron-down toggle-icon text-primary" id="statsToggleIcon"></i>
      </div>
      <div class="toggle-content" id="statsToggleContent">
        <div class="card-body">
          <!-- Summary Cards -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="summary-card text-center">
                <i class="fas fa-hand-holding-usd fa-2x mb-2"></i>
                <div>Total Credits</div>
                <div class="summary-value">TSh <%= totalCredits.toLocaleString() %></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="summary-card text-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                <div>Total Debits</div>
                <div class="summary-value">TSh <%= totalDebits.toLocaleString() %></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="summary-card text-center" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="fas fa-scale-balanced fa-2x mb-2"></i>
                <div>Net Balance</div>
                <div class="summary-value">TSh <%= netBalance.toLocaleString() %></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overall Statement -->
    <% if (isOfficial) { %>
      <div class="statement-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Overall Financial Statement</h3>
          <span class="badge bg-primary"><%= Object.keys(monthlyGroups.overall).length %> months</span>
        </div>
        <p class="text-muted">Period: <%= timeRange %></p>
        
        <% if (!overallTransactions || overallTransactions.length === 0) { %>
          <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>No transactions found for the selected period.
          </div>
        <% } else { %>
          <!-- Monthly Groupings with Pagination -->
          <div id="overall-months-container">
            <% Object.keys(monthlyGroups.overall).forEach((monthKey, index) => { 
                const monthData = monthlyGroups.overall[monthKey];
                const monthBalance = monthData.balance; %>
              <div class="month-section month-page" data-page="<%= Math.floor(index / 3) + 1 %>">
                <div class="month-header">
                  <h4 class="month-title"><i class="fas fa-calendar-alt me-2"></i><%= monthData.label %></h4>
                  <div class="month-summary">
                    Month Balance: TSh <%= monthBalance.toLocaleString() %>
                  </div>
                </div>
                
                <div class="table-responsive">
                  <table class="table table-hover table-sm">
                    <thead>
                      <tr>
                        <th width="5%">#</th>
                        <th width="12%">Date</th>
                        <th width="15%">Transaction ID</th>
                        <th width="18%">Member</th>
                        <th width="20%">Description</th>
                        <th width="10%" class="text-end">Credit (TSh)</th>
                        <th width="10%" class="text-end">Debit (TSh)</th>
                        <th width="10%" class="text-end">Balance (TSh)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% let runningMonthBalance = monthData.openingBalance; %>
                      <% monthData.transactions.forEach((t, index) => { %>
                        <tr>
                          <td class="fw-bold"><%= index + 1 %></td>
                          <td><%= new Date(t.created_at).toLocaleDateString('en-GB') %></td>
                          <td class="transaction-id">
                            <% if (t.txn_trn) { %>
                              <span class="badge bg-secondary"><%= t.txn_trn %></span>
                            <% } else { %>
                              <%
                                // Generate contribution ID in format: C-YYYY-MM-ID
                                const transactionDate = new Date(t.created_at);
                                const year = transactionDate.getFullYear();
                                const month = String(transactionDate.getMonth() + 1).padStart(2, '0');
                                const memberId = t.member_id || '000';
                                const contribId = `C-${year}-${month}-${memberId}`;
                              %>
                              <span class="badge bg-info"><%= contribId %></span>
                            <% } %>
                          </td>
                          <td>
                            <strong><%= t.first_name %> <%= t.sur_name %></strong>
                          </td>
                          <td>
                            <%= t.request_type %>
                            <% if (t.type === 'credit') { %>
                              <span class="badge badge-credit ms-1">CR</span>
                            <% } else { %>
                              <span class="badge badge-debit ms-1">DR</span>
                            <% } %>
                          </td>
                          <td class="text-end credit">
                            <%= t.type === 'credit' ? Number(t.amount).toLocaleString() : '-' %>
                          </td>
                          <td class="text-end debit">
                            <%= t.type === 'debit' ? Number(t.amount).toLocaleString() : '-' %>
                          </td>
                          <% runningMonthBalance += (t.type === 'credit' ? Number(t.amount) : -Number(t.amount)); %>
                          <td class="text-end balance"><%= runningMonthBalance.toLocaleString() %></td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% }) %>
          </div>
          
          <!-- Overall Pagination -->
          <div class="month-pagination" id="overall-pagination"></div>
          
          <div class="closing-balance p-3 text-end rounded mt-3">
            <h5 class="mb-0">Overall Closing Balance: TSh <%= overallClosingBalance.toLocaleString() %></h5>
          </div>
        <% } %>
      </div>
    <% } %>

    <!-- Individual Statement -->
    <div class="statement-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0"><i class="fas fa-user me-2"></i>Individual Statement - <%= user.first_name || user.username %> <%= user.sur_name || '' %></h3>
        <span class="badge bg-primary"><%= Object.keys(monthlyGroups.individual).length %> months</span>
      </div>
      <p class="text-muted">Period: <%= timeRange %></p>
      
      <% if (!individualTransactions || individualTransactions.length === 0) { %>
        <div class="alert alert-info text-center">
          <i class="fas fa-info-circle me-2"></i>No transactions found for your account in the selected period.
        </div>
      <% } else { %>
        <!-- Monthly Groupings for Individual with Pagination -->
        <div id="individual-months-container">
          <% Object.keys(monthlyGroups.individual).forEach((monthKey, index) => { 
              const monthData = monthlyGroups.individual[monthKey];
              const monthBalance = monthData.balance; %>
            <div class="month-section month-page" data-page="<%= Math.floor(index / 3) + 1 %>">
              <div class="month-header">
                <h4 class="month-title"><i class="fas fa-calendar-alt me-2"></i><%= monthData.label %></h4>
                <div class="month-summary">
                  Month Balance: TSh <%= monthBalance.toLocaleString() %>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-hover table-sm">
                  <thead>
                    <tr>
                      <th width="5%">#</th>
                      <th width="15%">Date</th>
                      <th width="20%">Transaction ID</th>
                      <th width="30%">Description</th>
                      <th width="15%" class="text-end">Credit (TSh)</th>
                      <th width="15%" class="text-end">Debit (TSh)</th>
                      <th width="15%" class="text-end">Balance (TSh)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% let runningMonthBalance = monthData.openingBalance; %>
                    <% monthData.transactions.forEach((t, index) => { %>
                      <tr>
                        <td class="fw-bold"><%= index + 1 %></td>
                        <td><%= new Date(t.created_at).toLocaleDateString('en-GB') %></td>
                        <td class="transaction-id">
                          <% if (t.txn_trn) { %>
                            <span class="badge bg-secondary"><%= t.txn_trn %></span>
                          <% } else { %>
                            <%
                              // Generate contribution ID in format: C-YYYY-MM-ID
                              const transactionDate = new Date(t.created_at);
                              const year = transactionDate.getFullYear();
                              const month = String(transactionDate.getMonth() + 1).padStart(2, '0');
                              const memberId = t.member_id || user.id || '000';
                              const contribId = `C-${year}-${month}-${memberId}`;
                            %>
                            <span class="badge bg-info"><%= contribId %></span>
                          <% } %>
                        </td>
                        <td>
                          <%= t.request_type %>
                          <% if (t.type === 'credit') { %>
                            <span class="badge badge-credit ms-1">CR</span>
                          <% } else { %>
                            <span class="badge badge-debit ms-1">DR</span>
                          <% } %>
                        </td>
                        <td class="text-end credit">
                          <%= t.type === 'credit' ? Number(t.amount).toLocaleString() : '-' %>
                        </td>
                        <td class="text-end debit">
                          <%= t.type === 'debit' ? Number(t.amount).toLocaleString() : '-' %>
                        </td>
                        <% runningMonthBalance += (t.type === 'credit' ? Number(t.amount) : -Number(t.amount)); %>
                        <td class="text-end balance"><%= runningMonthBalance.toLocaleString() %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            </div>
          <% }) %>
        </div>
        
        <!-- Individual Pagination -->
        <div class="month-pagination" id="individual-pagination"></div>
        
        <div class="closing-balance p-3 text-end rounded mt-3">
          <h5 class="mb-0">Individual Closing Balance: TSh <%= individualClosingBalance.toLocaleString() %></h5>
        </div>
      <% } %>
    </div>

    <!-- Additional Download Buttons at Bottom -->
    <div class="text-center mt-4">
      <div class="btn-group">
        <% if (isOfficial) { %>
          <!-- Show all three buttons for officials -->
          <a href="/financial-statement/pdf?type=overall<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-outline-success">
            <i class="fas fa-download me-1"></i>Download Overall PDF
          </a>
          <a href="/financial-statement/pdf?type=individual<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-outline-success">
            <i class="fas fa-download me-1"></i>Download Individual PDF
          </a>
          <a href="/financial-statement/pdf<%= pdfQuery ? '?' + pdfQuery : '' %>" class="btn btn-outline-success">
            <i class="fas fa-download me-1"></i>Download Both PDF
          </a>
        <% } else if (isMember) { %>
          <!-- Show only individual PDF button for regular members -->
          <a href="/financial-statement/pdf?type=individual<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-outline-success">
            <i class="fas fa-download me-1"></i>Download Individual PDF
          </a>
        <% } else { %>
          <!-- Fallback for other roles -->
          <a href="/financial-statement/pdf?type=individual<%= pdfQuery ? '&' + pdfQuery : '' %>" class="btn btn-outline-success">
            <i class="fas fa-download me-1"></i>Download PDF
          </a>
        <% } %>
      </div>
    </div>

  </div>
</div>

   <%- include('partials/change_password_modal') %>

<%- include('partials/footer') %>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery for pagination -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="/script/dashboard.js"></script>
<script src="/script/sidebar.js"></script>
<script src="/script/passwordModal.js"></script>
 <script src="/js/flash.js"></script>


<script>
  // Auto-dismiss flash messages after 5 seconds
  document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
      setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }, 5000);
    });

    // Add active class to current page in sidebar
    const currentPath = window.location.pathname;
    const sidebarLinks = document.querySelectorAll('.sidebar-nav a');
    sidebarLinks.forEach(link => {
      if (link.getAttribute('href') === currentPath) {
        link.classList.add('active');
      }
    });

    // Initialize toggle functionality
    initializeToggles();
    
    // Initialize pagination for both sections
    initializeMonthlyPagination();
  });

  // Toggle functionality
  function initializeToggles() {
    // Filter Toggle
    const filterToggle = document.getElementById('filterToggleHeader');
    const filterContent = document.getElementById('filterToggleContent');
    const filterIcon = document.getElementById('filterToggleIcon');

    // Stats Toggle
    const statsToggle = document.getElementById('statsToggleHeader');
    const statsContent = document.getElementById('statsToggleContent');
    const statsIcon = document.getElementById('statsToggleIcon');

    // Filter toggle event
    if (filterToggle) {
      filterToggle.addEventListener('click', function() {
        filterContent.classList.toggle('show');
        filterIcon.classList.toggle('rotated');
      });
    }

    // Stats toggle event
    if (statsToggle) {
      statsToggle.addEventListener('click', function() {
        statsContent.classList.toggle('show');
        statsIcon.classList.toggle('rotated');
      });
    }
  }

  function initializeMonthlyPagination() {
    // Initialize Overall Statement Pagination
    <% if (isOfficial && overallTransactions && overallTransactions.length > 0) { %>
      const overallMonths = document.querySelectorAll('#overall-months-container .month-page');
      const overallPages = Math.ceil(overallMonths.length / 3); // 3 months per page
      createPagination('overall-pagination', overallPages, 'overall');
      
      // Show first page initially
      showPage('overall', 1);
    <% } %>

    // Initialize Individual Statement Pagination
    <% if (individualTransactions && individualTransactions.length > 0) { %>
      const individualMonths = document.querySelectorAll('#individual-months-container .month-page');
      const individualPages = Math.ceil(individualMonths.length / 3); // 3 months per page
      createPagination('individual-pagination', individualPages, 'individual');
      
      // Show first page initially
      showPage('individual', 1);
    <% } %>
  }

  function createPagination(containerId, totalPages, type) {
    const container = document.getElementById(containerId);
    if (!container || totalPages <= 1) return;

    let paginationHTML = `
      <nav aria-label="Monthly ${type} pagination">
        <ul class="pagination pagination-sm">
    `;

    // Previous button
    paginationHTML += `
      <li class="page-item">
        <a class="page-link prev-page" href="#" data-type="${type}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
      paginationHTML += `
        <li class="page-item">
          <a class="page-link page-number ${i === 1 ? 'active' : ''}" href="#" data-type="${type}" data-page="${i}">${i}</a>
        </li>
      `;
    }

    // Next button
    paginationHTML += `
      <li class="page-item">
        <a class="page-link next-page" href="#" data-type="${type}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    `;

    paginationHTML += `
        </ul>
      </nav>
    `;

    container.innerHTML = paginationHTML;

    // Add event listeners
    container.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (e.target.classList.contains('page-number')) {
        const page = parseInt(e.target.getAttribute('data-page'));
        const type = e.target.getAttribute('data-type');
        showPage(type, page);
        updatePaginationActiveState(type, page);
      } else if (e.target.classList.contains('prev-page')) {
        const type = e.target.getAttribute('data-type');
        const currentPage = getCurrentPage(type);
        if (currentPage > 1) {
          showPage(type, currentPage - 1);
          updatePaginationActiveState(type, currentPage - 1);
        }
      } else if (e.target.classList.contains('next-page')) {
        const type = e.target.getAttribute('data-type');
        const currentPage = getCurrentPage(type);
        const totalPages = type === 'overall' ? 
          Math.ceil(document.querySelectorAll('#overall-months-container .month-page').length / 3) :
          Math.ceil(document.querySelectorAll('#individual-months-container .month-page').length / 3);
        
        if (currentPage < totalPages) {
          showPage(type, currentPage + 1);
          updatePaginationActiveState(type, currentPage + 1);
        }
      }
    });
  }

  function showPage(type, page) {
    const containerId = type === 'overall' ? 'overall-months-container' : 'individual-months-container';
    const months = document.querySelectorAll(`#${containerId} .month-page`);
    
    // Hide all months
    months.forEach(month => {
      month.style.display = 'none';
    });
    
    // Show months for current page (3 months per page)
    const startIndex = (page - 1) * 3;
    const endIndex = startIndex + 3;
    
    for (let i = startIndex; i < endIndex && i < months.length; i++) {
      months[i].style.display = 'block';
    }
    
    // Store current page
    sessionStorage.setItem(`${type}-current-page`, page);
  }

  function getCurrentPage(type) {
    return parseInt(sessionStorage.getItem(`${type}-current-page`)) || 1;
  }

  function updatePaginationActiveState(type, activePage) {
    const containerId = `${type}-pagination`;
    const pagination = document.getElementById(containerId);
    
    if (pagination) {
      // Remove active class from all page numbers
      pagination.querySelectorAll('.page-number').forEach(link => {
        link.classList.remove('active');
      });
      
      // Add active class to current page
      const activeLink = pagination.querySelector(`.page-number[data-page="${activePage}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
    }
  }

  // Format currency function
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-TZ', {
      style: 'currency',
      currency: 'TZS',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }

  // Export to CSV functionality
  function exportFinancialStatementToCSV(type = 'both') {
    let transactions = [];
    let filename = 'financial_statement_';
    
    if (type === 'overall') {
      transactions = <%- JSON.stringify(overallTransactions || []) %>;
      filename += 'overall.csv';
    } else if (type === 'individual') {
      transactions = <%- JSON.stringify(individualTransactions || []) %>;
      filename += 'individual.csv';
    } else {
      transactions = [
        ...<%- JSON.stringify(overallTransactions || []) %>,
        ...<%- JSON.stringify(individualTransactions || []) %>
      ];
      filename += 'complete.csv';
    }

    if (transactions.length === 0) {
      alert('No data to export');
      return;
    }

    const headers = ['Date', 'Type', 'Transaction ID', 'Member', 'Description', 'Credit', 'Debit', 'Amount'];
    
    const csvContent = [
      headers.join(','),
      ...transactions.map(t => [
        new Date(t.created_at).toLocaleDateString('en-GB'),
        t.type,
        t.txn_trn || 'CONTRIB',
        `"${t.first_name} ${t.sur_name}"`,
        `"${t.request_type}"`,
        t.type === 'credit' ? Number(t.amount).toLocaleString() : '',
        t.type === 'debit' ? Number(t.amount).toLocaleString() : '',
        Number(t.amount).toLocaleString()
      ].join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }
</script>
</body>
</html>



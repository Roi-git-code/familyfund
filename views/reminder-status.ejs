
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reminder Status - Family Fund</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/flash.css">

  <style>
    /* Contribution level colors */
    .contrib-high {
      background-color: #90ee90; /* light green */
    }

    .contrib-mid {
      background-color: #add8e6; /* light blue */
    }

    .contrib-low {
      background-color: #ffff99; /* yellow */
    }

    .contrib-verylow {
      background-color: #ff9999; /* light red */
    }

    /* Table overflow styling */
    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
    }

    /* Status cards styling */
    .status-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .progress-bar-custom {
      height: 25px;
      border-radius: 12px;
      overflow: hidden;
    }

    .member-row {
      padding: 15px;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }

    .member-row:hover {
      background-color: #f8f9fa;
    }

    .member-row:last-child {
      border-bottom: none;
    }

    .reminder-needed {
      border-left: 5px solid #ffc107;
      background-color: #fff3cd;
    }

    .complete {
      border-left: 5px solid #28a745;
      background-color: #d4edda;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
    }

    .stat-label {
      color: #6c757d;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    /* Alert styling */
    .reminder-alert {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border-left: 5px solid #ffc107;
    }

    /* Button styling */
    .btn-reminder {
      background: linear-gradient(135deg, #ffc107, #ff9800);
      border: none;
      color: white;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s ease;
    }

    .btn-reminder:hover {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
      color: white;
    }

    /* Modal styling */
    .modal-reminder .modal-header {
      background: linear-gradient(135deg, #ffc107, #ff9800);
      color: white;
    }

    .modal-reminder .modal-body {
      padding: 2rem;
    }

    .modal-reminder .bi-exclamation-triangle {
      font-size: 3rem;
      color: #ffc107;
      margin-bottom: 1rem;
    }
  </style>

</head>
<body>

 <%- include('partials/header') %>

<%- include('partials/sidebar', { user: user }) %>

<div class="container-fluid">
  <div class="row">
    <div class="col-lg-2 col-md-3 d-none d-md-block">
      <!-- Left sidebar for additional navigation if needed -->
    </div>
    
    <div class="col-lg-10 col-md-9 ms-sm-auto px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
          <i class="bi bi-bell-fill text-warning"></i>
          Contribution Reminder System
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <a href="/contributions" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Contributions
          </a>
        </div>
      </div>

      <%- include('partials/flash') %>

      <!-- System Status Card -->
      <div class="status-card">
        <h3 class="mb-4">
          <i class="bi bi-speedometer2"></i>
          System Status
        </h3>
        
        <div class="row">
          <div class="col-md-4 mb-3">
            <div class="text-center p-3 border rounded bg-light">
              <div class="stat-number"><%= totalMembers %></div>
              <div class="stat-label">Total Members</div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="text-center p-3 border rounded bg-light">
              <div class="stat-number" style="color: <%= needReminderCount > 0 ? '#dc3545' : '#28a745' %>">
                <%= needReminderCount %>
              </div>
              <div class="stat-label">Need Reminders</div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="text-center p-3 border rounded bg-light">
              <div class="stat-number" style="color: <%= isReminderDay ? '#28a745' : '#6c757d' %>">
                <%= isReminderDay ? 'YES' : 'NO' %>
              </div>
              <div class="stat-label">Reminder Day</div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <h5>
              <i class="bi bi-calendar-check"></i>
              Current Information
            </h5>
            <div class="list-group">
              <div class="list-group-item">
                <strong>Month:</strong> <%= currentMonth %>
              </div>
              <div class="list-group-item">
                <strong>Today:</strong> <%= today %> (<%= now %>)
              </div>
              <div class="list-group-item">
                <strong>Reminder Days:</strong> 20th, 24th, 28th, 30th at 10:00 AM Tanzania Time
              </div>
              <div class="list-group-item">
                <strong>Monthly Target:</strong> TSh 20,000 per member
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <h5>
              <i class="bi bi-gear"></i>
              Actions
            </h5>
            <div class="d-grid gap-2">
              <!-- Button triggers modal instead of direct link -->
              <button type="button" 
                 class="btn btn-reminder" 
                 data-bs-toggle="modal" 
                 data-bs-target="#reminderConfirmationModal">
                 <i class="bi bi-send-fill"></i> Send Reminders Now
              </button>
            </div>
            
            <% if (!isReminderDay) { %>
            <div class="alert alert-warning mt-3 reminder-alert">
              <i class="bi bi-info-circle"></i>
              <strong>Note:</strong> Today is not a reminder day. 
              Reminders can only be sent manually today.
            </div>
            <% } else { %>
            <div class="alert alert-success mt-3">
              <i class="bi bi-check-circle"></i>
              <strong>Note:</strong> Today is a reminder day. 
              Reminders will be sent automatically at 10:00 AM.
            </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Member Status Card -->
      <div class="status-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>
            <i class="bi bi-people-fill"></i>
            Member Contribution Status
          </h3>
          <span class="badge bg-secondary">
            Showing <%= checkedMembers %> of <%= totalMembers %> members
          </span>
        </div>
        
        <% if (members.length === 0) { %>
          <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i>
            No members found or unable to load member data.
          </div>
        <% } else { %>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th><i class="bi bi-person"></i> Member</th>
                  <th><i class="bi bi-cash-coin"></i> Current Contribution</th>
                  <th><i class="bi bi-graph-up"></i> Progress</th>
                  <th><i class="bi bi-tags"></i> Status</th>
                </tr>
              </thead>
              <tbody>
                <% members.forEach(member => { %>
                <tr class="member-row <%= member.needsReminder ? 'reminder-needed' : 'complete' %>">
                  <td>
                    <div class="fw-bold"><%= member.name %></div>
                    <small class="text-muted">ID: <%= member.id %></small>
                  </td>
                  <td>
                    <div class="fw-bold">
                      TSh <%= member.currentContribution.toLocaleString() %> / 20,000
                    </div>
                    <% if (member.needsReminder) { %>
                      <div class="text-danger small">
                        <i class="bi bi-exclamation-triangle"></i>
                        Needs: TSh <%= member.remainingAmount.toLocaleString() %>
                      </div>
                    <% } else { %>
                      <div class="text-success small">
                        <i class="bi bi-check-circle"></i>
                        Exceeded by TSh <%= (member.currentContribution - 20000).toLocaleString() %>
                      </div>
                    <% } %>
                  </td>
                  <td>
                    <div class="progress progress-bar-custom mb-2">
                      <div class="progress-bar 
                        <%= member.percentage >= 100 ? 'bg-success' : (member.percentage >= 50 ? 'bg-warning' : 'bg-danger') %>" 
                        style="width: <%= member.percentage %>%"
                        role="progressbar"
                        aria-valuenow="<%= member.percentage %>"
                        aria-valuemin="0"
                        aria-valuemax="100">
                      </div>
                    </div>
                    <div class="text-center small text-muted">
                      <%= member.percentage %>% complete
                    </div>
                  </td>
                  <td>
                    <span class="badge <%= member.needsReminder ? 'bg-warning' : 'bg-success' %>">
                      <%= member.needsReminder ? 'Needs Reminder' : 'Complete' %>
                    </span>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>

      <!-- Info Card -->
      <div class="status-card">
        <h4 class="mb-4">
          <i class="bi bi-question-circle"></i>
          How the Reminder System Works
        </h4>
        
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header bg-info text-white">
                <i class="bi bi-clock"></i> Automatic Schedule
              </div>
              <div class="card-body">
                <ol class="mb-0">
                  <li>System checks daily at 10:00 AM Tanzania time</li>
                  <li>On reminder days (20th, 24th, 28th, 30th), it automatically sends emails</li>
                  <li>Only members with less than TSh 20,000 receive reminders</li>
                </ol>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header bg-success text-white">
                <i class="bi bi-gear"></i> Manual Control
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li>You can send reminders manually at any time</li>
                  <li>Manual sends bypass the reminder day restriction</li>
                  <li>Useful for testing or urgent reminders</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <div class="alert alert-info">
          <i class="bi bi-lightbulb"></i>
          <strong>Tip:</strong> Check back on reminder days to see the system in action automatically!
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reminder Confirmation Modal -->
<div class="modal fade" id="reminderConfirmationModal" tabindex="-1" aria-labelledby="reminderConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-reminder">
      <div class="modal-header">
        <h5 class="modal-title" id="reminderConfirmationModalLabel">
          <i class="bi bi-exclamation-triangle-fill"></i>
          Send Reminder Confirmation
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-4">
          <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
        </div>
        
        <h4 class="mb-3">Are you sure?</h4>
        
        <div class="alert alert-warning mb-4">
          <p class="mb-0">
            <strong>Send reminders to ALL members who have contributed less than TSh 20,000 this month?</strong>
          </p>
        </div>
        
        <div class="mb-4">
          <p class="text-muted">
            This will send email reminders to <strong><%= needReminderCount %> members</strong> who haven't reached the monthly target.
          </p>
          
          <% if (needReminderCount > 0) { %>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <small>
              <strong>Affected Members:</strong> <%= needReminderCount %> members will receive reminders.<br>
              <strong>Excluded:</strong> <%= checkedMembers - needReminderCount %> members have already paid TSh 20,000+.
            </small>
          </div>
          <% } else { %>
          <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <small>No members need reminders - all have paid TSh 20,000 or more this month.</small>
          </div>
          <% } %>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <a href="/contributions/reminders/send-now" class="btn btn-warning" id="confirmSendReminders">
          <i class="bi bi-send-fill"></i> Yes, Send Reminders
        </a>
      </div>
    </div>
  </div>
</div>

<%- include('partials/change_password_modal') %>

<%- include('partials/footer') %>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/script/dashboard.js"></script>
<script src="/script/sidebar.js"></script>
<script src="/js/flash.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh status every 5 minutes
    setInterval(function() {
      console.log('Auto-refreshing reminder status...');
      // You could add auto-refresh logic here if needed
    }, 300000); // 5 minutes
    
    // Highlight current day if it's a reminder day
    const reminderDayBadge = document.querySelector('.stat-number:last-child');
    if (reminderDayBadge && reminderDayBadge.textContent === 'YES') {
      reminderDayBadge.parentElement.classList.add('border-success', 'border-2');
    }
    
    // Handle modal confirmation button
    const confirmButton = document.getElementById('confirmSendReminders');
    const needReminderCount = <%= needReminderCount %>;
    
    if (confirmButton) {
      confirmButton.addEventListener('click', function(e) {
        if (needReminderCount === 0) {
          e.preventDefault();
          alert('No members need reminders. All members have already paid TSh 20,000 or more this month.');
          const modal = bootstrap.Modal.getInstance(document.getElementById('reminderConfirmationModal'));
          if (modal) modal.hide();
        }
      });
    }
    
    // Update modal content dynamically based on needReminderCount
    const reminderModal = document.getElementById('reminderConfirmationModal');
    if (reminderModal) {
      reminderModal.addEventListener('show.bs.modal', function(event) {
        const modalTitle = this.querySelector('.modal-title');
        const modalBody = this.querySelector('.modal-body');
        const confirmBtn = this.querySelector('#confirmSendReminders');
        
        if (needReminderCount === 0) {
          modalTitle.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> No Reminders Needed';
          confirmBtn.classList.remove('btn-warning');
          confirmBtn.classList.add('btn-success');
          confirmBtn.innerHTML = '<i class="bi bi-check-circle"></i> OK';
          confirmBtn.disabled = true;
        }
      });
    }
  });
</script>
</body>
</html>



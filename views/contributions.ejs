<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Member Contributions</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/app.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Contribution level colors */
.contribution-page .contrib-high {
  background-color: #90ee90; /* light green */
}

.contribution-page .contrib-mid {
  background-color: #add8e6; /* light blue */
}

.contribution-page .contrib-low {
  background-color: #ffff99; /* yellow */
}

.contribution-page .contrib-verylow {
  background-color: #ff9999; /* light red */
}
</style>

</head>
<body>

 <%- include('partials/header') %>

<%- include('partials/sidebar', { user: user }) %>
<div class="container my-4">
 
  <% if (user) { %>
    <p>
      You are logged in as <strong><%= user.username %></strong>
      (<%= user.role %>)
      <a href="/">Go to Home</a> |
      <a href="/auth/logout">Logout</a>
    </p>
  <% } %>

  <!-- Flash Messages -->
  <div id="flashContainer">
    <% if (flash && flash.success) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= flash.success[0] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>
    <% if (flash && flash.error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= flash.error[0] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>
  </div>

  <!-- Filter Form -->
  <form method="GET" action="/contributions" id="filterForm" class="row g-3 mb-3 align-items-end">
    <div class="col-md-2">
      <label for="member_id" class="form-label">Member</label>
      <select name="member_id" id="member_id" class="form-select">
        <option value="">All Members</option>
        <% members.forEach(m => { %>
          <option value="<%= m.id %>" <%= selectedMember == m.id ? 'selected' : '' %>>
            <%= m.first_name %> <%= m.sur_name %>
          </option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <label for="year" class="form-label">Year</label>
      <select name="year" id="year" class="form-select">
        <option value="">All Years</option>
        <% years.forEach(y => { %>
          <option value="<%= y %>" <%= selectedYear == y ? 'selected' : '' %>><%= y %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <label for="from" class="form-label">From</label>
      <input type="month" name="from" id="from" value="<%= from || '' %>" class="form-control">
    </div>
    <div class="col-md-2">
      <label for="to" class="form-label">To</label>
      <input type="month" name="to" id="to" value="<%= to || '' %>" class="form-control">
    </div>
    <div class="col-md-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="/download/contributions/pdf?<%= [
        selectedMember ? `member_id=${selectedMember}` : '',
        selectedYear ? `year=${selectedYear}` : '',
        from ? `from=${from}` : '',
        to ? `to=${to}` : ''
      ].filter(Boolean).join('&') %>" class="btn btn-success">Download PDF</a>
    </div>
  </form>

  <!-- Import CSV -->
  <form method="post" action="/contributions/import" enctype="multipart/form-data" class="mb-3 d-flex gap-2 align-items-center">
    <input type="file" name="csvfile" accept=".csv" class="form-control" required>
    <button type="submit" class="btn btn-secondary">Import CSV</button>
  </form>

  <h2 class="text-center mb-3">Member Contributions</h2>

  <% if (rows.length === 0) { %>
    <p class="text-danger text-center">No data for selected filters</p>
  <% } %>

  <% if (filterSummary) { %>
    <div class="alert alert-info"><strong><%= filterSummary %></strong></div>
  <% } %>

  <!-- Contributions Table -->
  <div class="table-responsive mb-3">
    <table class="table table-bordered table-hover" id="contribution-table">
      <thead class="table-primary sticky-top">
        <tr>
          <th>Member</th><th>Year</th><th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th>
          <th>Jun</th><th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
          <th>TotalYear</th><th>TotalAllYears</th><th>% Yr</th>
          <% if (user && user.role === 'chief_signatory') { %><th>Actions</th><% } %>
        </tr>
      </thead>
      <tbody>
        <% rows.forEach(row => {
          const lifetime = memberTotals[row.member_id];
          const percentYear = ((row.total_year / lifetime) * 100).toFixed(1);
        %>
          <tr>
            <td><%= row.first_name %> <%= row.middle_name || '' %> <%= row.sur_name %></td>
            <td><%= row.year %></td>
            <td><%= row.jan %></td><td><%= row.feb %></td><td><%= row.mar %></td><td><%= row.apr %></td><td><%= row.may %></td><td><%= row.jun %></td>
            <td><%= row.jul %></td><td><%= row.aug %></td><td><%= row.sep %></td><td><%= row.oct %></td><td><%= row.nov %></td><td><%= row.dec %></td>
            <td><%= row.total_year.toFixed(2) %></td>
            <td><%= lifetime.toFixed(2) %></td>
            <td><%= percentYear %>%</td>
            <% if (user && user.role === 'chief_signatory') { %>
              <td><a href="/contributions/edit/<%= row.member_id %>/<%= row.year %>" class="btn btn-sm btn-warning">Edit</a></td>
            <% } %>
          </tr>
        <% }) %>
        <tr class="table-secondary fw-bold">
          <th colspan="2">Total</th>
          <% ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'].forEach(m => { %>
            <th><%= (monthlySummary[m]||0).toFixed(2) %></th>
          <% }) %>
          <th><%= rows.reduce((s,r) => s + r.total_year,0).toFixed(2) %></th>
          <th><%= Object.values(memberTotals).reduce((s,v)=>s+v,0).toFixed(2) %></th>
          <th>–</th>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex gap-2 justify-content-center mb-4">
    <a href="/contributions/download/contributions/pdf?<%= [
      selectedMember ? `member_id=${selectedMember}` : '',
      selectedYear ? `year=${selectedYear}` : '',
      from ? `from=${from}` : '',
      to ? `to=${to}` : ''
    ].filter(Boolean).join('&') %>" class="btn btn-success">Download Contributions PDF</a>
    <button onclick="exportTableToCSV('contributions.csv')" class="btn btn-secondary">Export CSV</button>
  </div>

  <!-- Chart -->
  <canvas id="yearChart" class="d-block mx-auto mb-4" style="max-width:900px;"></canvas>

  <!-- Contribution Summary Table -->


  <div class="table-responsive">
    <h2 class="text-center mb-3">Members Contribution Summary</h2>
    <table class="table table-bordered table-hover text-center">
      <thead class="table-primary">
        <tr>
          <th>Member Name</th>
          <th>Total Contribution (TSh)</th>
          <th>% of All Contributions</th>
          <th>Indicator</th>
        </tr>
      </thead>
      <tbody>
        <% summaryData.members.forEach(m => { %>
        <tr>
            <td><%= m.full_name %></td>
            <td><%= Number(m.total_contribution).toLocaleString() %></td>
            <td><%= m.percentageOfAll %> %</td>
            <td>
  <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
    <span 
      style="display:inline-block; width:18px; height:18px; border-radius:50%; background-color:<%= m.color %>;">
    </span>
    <span style="font-size:12px; color:#555;"><%= m.color %></span>
  </div>
</td>

          </tr>
        <% }) %>
      </tbody>
      <tfoot class="table-secondary fw-bold">
        <% 
          const totalContributionsSum = summaryData.members.reduce((s,x)=> s + Number(x.total_contribution || 0), 0);
          const totalPercentageSum = summaryData.members.reduce((s,x)=> s + Number(x.percentageOfAll || 0), 0);
        %>
        <tr>
          <th>Total</th>
          <th><%= totalContributionsSum.toLocaleString() %></th>
          <th><%= totalPercentageSum.toFixed(2) %> %</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>

<div class="buttons">
    <a href="/contributions/download/summary/pdf?<%= [
      selectedMember ? `member_id=${selectedMember}` : '',
      selectedYear ? `year=${selectedYear}` : '',
      from ? `from=${from}` : '',
      to ? `to=${to}` : ''
    ].filter(Boolean).join('&') %>" class="button">⬇ Download Summary PDF</a>
  </div>

</div>

<%- include('partials/footer') %>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/script/dashboard.js"></script>
<script src="/script/sidebar.js"></script>

<script>
  function exportTableToCSV(filename = '') {
    const rows = document.querySelectorAll("table tr");
    const csv = [...rows].map(r =>
      [...r.querySelectorAll("th,td")]
        .map(c => `"${c.innerText.replace(/"/g,'""')}"`).join(",")
    ).join("\n");

    const blob = new Blob([csv], {type:'text/csv'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Chart.js
  const rowsData = <%- JSON.stringify(rowsData) %>;
  (function(){
    const years = [...new Set(rowsData.map(r => r.year))].sort((a,b)=> a-b);
    const sums = years.map(y => rowsData.filter(r=>r.year===y)
                                       .reduce((s,r)=> s + Number(r.total_year || 0), 0));
    if (!years.length) return;
    new Chart(document.getElementById("yearChart"), {
      type: 'bar',
      data: { labels: years, datasets: [{ label: 'Total per Year', backgroundColor: '#007bff', data: sums }] },
      options: { responsive:true, scales: { y: { beginAtZero:true } } }
    });
  })();
</script>
</body>
</html>




<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Member Contributions</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/flash.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Contribution level colors */
.contribution-page .contrib-high {
  background-color: #90ee90; /* light green */
}

.contribution-page .contrib-mid {
  background-color: #add8e6; /* light blue */
}

.contribution-page .contrib-low {
  background-color: #ffff99; /* yellow */
}

.contribution-page .contrib-verylow {
  background-color: #ff9999; /* light red */
}

/* Table overflow styling */
.table-container {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}

/* Pagination styling */
.pagination-container {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}

/* Filter form toggle */
.filter-toggle {
  cursor: pointer;
  padding: 0.5rem 1rem;
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  margin-bottom: 1rem;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-toggle:hover {
  background-color: #e9ecef;
}

.filter-toggle .icon {
  transition: transform 0.3s ease;
}

.filter-toggle.collapsed .icon {
  transform: rotate(-90deg);
}

        .reminder-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .reminder-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.4);
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            text-decoration: none;
        }
        
        .reminder-btn:active {
            transform: translateY(0);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
</style>

</head>
<body>

 <%- include('partials/header') %>

<%- include('partials/sidebar', { user: user }) %>
<div class="container my-4">
 <%- include('partials/flash') %>

  <!-- Filter Toggle Button -->
  <div class="filter-toggle collapsed" id="filterToggle" data-bs-toggle="collapse" data-bs-target="#filterFormContainer" aria-expanded="false" aria-controls="filterFormContainer">
    <span class="icon">â–¼</span>
    <span>Show Filters</span>
  </div>

      <!-- Floating Reminder Button -->
    <a href="/contributions/reminders/status" class="reminder-btn">
        ðŸ“… Reminders
        <span class="notification-badge" id="reminderCount">!</span>
    </a>


  <!-- Filter Form Container -->
  <div class="collapse" id="filterFormContainer">
    <form method="GET" action="/contributions" id="filterForm" class="row g-3 mb-3 align-items-end">
      <div class="col-md-2">
        <label for="member_id" class="form-label">Member</label>
        <select name="member_id" id="member_id" class="form-select">
          <option value="">All Members</option>
          <% members.forEach(m => { %>
            <option value="<%= m.id %>" <%= selectedMember == m.id ? 'selected' : '' %>>
              <%= m.first_name %> <%= m.sur_name %>
            </option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-2">
        <label for="year" class="form-label">Year</label>
        <select name="year" id="year" class="form-select">
          <option value="">All Years</option>
          <% years.forEach(y => { %>
            <option value="<%= y %>" <%= selectedYear == y ? 'selected' : '' %>><%= y %></option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-2">
        <label for="from" class="form-label">From</label>
        <input type="month" name="from" id="from" value="<%= from || '' %>" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="to" class="form-label">To</label>
        <input type="month" name="to" id="to" value="<%= to || '' %>" class="form-control">
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="/download/contributions/pdf?<%= [
          selectedMember ? `member_id=${selectedMember}` : '',
          selectedYear ? `year=${selectedYear}` : '',
          from ? `from=${from}` : '',
          to ? `to=${to}` : ''
        ].filter(Boolean).join('&') %>" class="btn btn-success">Download PDF</a>
      </div>
    </form>

    <!-- Import CSV -->
    <form method="post" action="/contributions/import" enctype="multipart/form-data" class="mb-3 d-flex gap-2 align-items-center">
      <input type="file" name="csvfile" accept=".csv" class="form-control" required>
      <button type="submit" class="btn btn-secondary">Import CSV</button>
    </form>
  </div>

  <h2 class="text-center mb-3">Member Contributions</h2>

  <% if (rows.length === 0) { %>
    <p class="text-danger text-center">No data for selected filters</p>
  <% } %>

  <% if (filterSummary) { %>
    <div class="alert alert-info"><strong><%= filterSummary %></strong></div>
  <% } %>

  <!-- Contributions Table -->
  <div class="table-container mb-3">
    <table class="table table-bordered table-hover" id="contribution-table">
      <thead class="table-primary sticky-top">
        <tr>
          <th>Member</th><th>Year</th><th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th>
          <th>Jun</th><th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
          <th>TotalYear</th><th>TotalAllYears</th><th>% Yr</th>
          <% if (user && user.role === 'chief_signatory') { %><th>Actions</th><% } %>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Table content will be populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div class="pagination-container">
    <nav>
      <ul class="pagination" id="pagination">
        <!-- Pagination will be generated by JavaScript -->
      </ul>
    </nav>
  </div>

  <div class="d-flex gap-2 justify-content-center mb-4">
    <a href="/contributions/download/contributions/pdf?<%= [
      selectedMember ? `member_id=${selectedMember}` : '',
      selectedYear ? `year=${selectedYear}` : '',
      from ? `from=${from}` : '',
      to ? `to=${to}` : ''
    ].filter(Boolean).join('&') %>" class="btn btn-success">Download Contributions PDF</a>
    <button onclick="exportTableToCSV('contributions.csv')" class="btn btn-secondary">Export CSV</button>
  </div>

   <!--  Reminder Status Button -->
    <a href="/contributions/reminders/status" class="btn btn-warning">
        <i class="bi bi-bell-fill"></i> Reminder Status
    </a>

  <!-- Chart -->
  <canvas id="yearChart" class="d-block mx-auto mb-4" style="max-width:900px;"></canvas>

  <!-- Contribution Summary Table -->
  <div class="table-responsive">
    <h2 class="text-center mb-3">Members Contribution Summary</h2>
    <table class="table table-bordered table-hover text-center">
      <thead class="table-primary">
        <tr>
          <th>Member Name</th>
          <th>Total Contribution (TSh)</th>
          <th>% of All Contributions</th>
          <th>Indicator</th>
        </tr>
      </thead>
      <tbody>
        <% summaryData.members.forEach(m => { %>
        <tr>
            <td><%= m.full_name %></td>
            <td><%= Number(m.total_contribution).toLocaleString() %></td>
            <td><%= m.percentageOfAll %> %</td>
            <td>
  <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
    <span 
      style="display:inline-block; width:18px; height:18px; border-radius:50%; background-color:<%= m.color %>;">
    </span>
    <span style="font-size:12px; color:#555;"><%= m.color %></span>
  </div>
</td>

          </tr>
        <% }) %>
      </tbody>
      <tfoot class="table-secondary fw-bold">
        <% 
          const totalContributionsSum = summaryData.members.reduce((s,x)=> s + Number(x.total_contribution || 0), 0);
          const totalPercentageSum = summaryData.members.reduce((s,x)=> s + Number(x.percentageOfAll || 0), 0);
        %>
        <tr>
          <th>Total</th>
          <th><%= totalContributionsSum.toLocaleString() %></th>
          <th><%= totalPercentageSum.toFixed(2) %> %</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>

<div class="buttons">
    <a href="/contributions/download/summary/pdf?<%= [
      selectedMember ? `member_id=${selectedMember}` : '',
      selectedYear ? `year=${selectedYear}` : '',
      from ? `from=${from}` : '',
      to ? `to=${to}` : ''
    ].filter(Boolean).join('&') %>" class="button">â¬‡ Download Summary PDF</a>
  </div>

</div>
<%- include('partials/change_password_modal') %>

<%- include('partials/footer') %>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/script/dashboard.js"></script>
<script src="/script/sidebar.js"></script>
  <script src="/js/flash.js"></script>


<script>
  // Pagination configuration
  const rowsPerPage = 10;
  let currentPage = 1;
  const allRows = [
    <% rows.forEach(row => {
      const lifetime = memberTotals[row.member_id];
      const percentYear = ((row.total_year / lifetime) * 100).toFixed(1);
    %>
      {
        member: `<%= row.first_name %> <%= row.middle_name || '' %> <%= row.sur_name %>`,
        year: `<%= row.year %>`,
        jan: `<%= row.jan %>`,
        feb: `<%= row.feb %>`,
        mar: `<%= row.mar %>`,
        apr: `<%= row.apr %>`,
        may: `<%= row.may %>`,
        jun: `<%= row.jun %>`,
        jul: `<%= row.jul %>`,
        aug: `<%= row.aug %>`,
        sep: `<%= row.sep %>`,
        oct: `<%= row.oct %>`,
        nov: `<%= row.nov %>`,
        dec: `<%= row.dec %>`,
        total_year: `<%= row.total_year.toFixed(2) %>`,
        total_all_years: `<%= lifetime.toFixed(2) %>`,
        percent_year: `<%= percentYear %>%`,
        <% if (user && user.role === 'chief_signator') { %>
          actions: `<a href="/contributions/edit/<%= row.member_id %>/<%= row.year %>" class="btn btn-sm btn-warning">Edit</a>`
        <% } %>
      },
    <% }) %>
  ];

  // Initialize table and pagination
  function initializeTable() {
    renderTable();
    renderPagination();
  }

  // Render table rows for current page
  function renderTable() {
    const tableBody = document.getElementById('tableBody');
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const currentRows = allRows.slice(startIndex, endIndex);

    let html = '';
    
    // Render data rows
    currentRows.forEach(row => {
      html += `
        <tr>
          <td>${row.member}</td>
          <td>${row.year}</td>
          <td>${row.jan}</td>
          <td>${row.feb}</td>
          <td>${row.mar}</td>
          <td>${row.apr}</td>
          <td>${row.may}</td>
          <td>${row.jun}</td>
          <td>${row.jul}</td>
          <td>${row.aug}</td>
          <td>${row.sep}</td>
          <td>${row.oct}</td>
          <td>${row.nov}</td>
          <td>${row.dec}</td>
          <td>${row.total_year}</td>
          <td>${row.total_all_years}</td>
          <td>${row.percent_year}</td>
          <% if (user && user.role === 'chief_signatory') { %>
            <td>${row.actions}</td>
          <% } %>
        </tr>
      `;
    });

    // Add summary row
    html += `
      <tr class="table-secondary fw-bold">
        <th colspan="2">Total</th>
        <% ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'].forEach(m => { %>
          <th><%= (monthlySummary[m]||0).toFixed(2) %></th>
        <% }) %>
        <th><%= rows.reduce((s,r) => s + r.total_year,0).toFixed(2) %></th>
        <th><%= Object.values(memberTotals).reduce((s,v)=>s+v,0).toFixed(2) %></th>
        <th>â€“</th>
        <% if (user && user.role === 'chief_signatory') { %><th></th><% } %>
      </tr>
    `;

    tableBody.innerHTML = html;
  }

  // Render pagination controls
  function renderPagination() {
    const totalPages = Math.ceil(allRows.length / rowsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    let html = '';

    // Previous button
    html += `
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
      </li>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
      html += `
        <li class="page-item ${currentPage === i ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
        </li>
      `;
    }

    // Next button
    html += `
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
      </li>
    `;

    pagination.innerHTML = html;
  }

  // Change page function
  function changePage(page) {
    const totalPages = Math.ceil(allRows.length / rowsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    renderTable();
    renderPagination();
    
    // Scroll to top of table
    document.querySelector('.table-container').scrollTop = 0;
  }

  // Filter toggle functionality
  document.addEventListener('DOMContentLoaded', function() {
    const filterToggle = document.getElementById('filterToggle');
    const filterFormContainer = document.getElementById('filterFormContainer');
    
    filterToggle.addEventListener('click', function() {
      this.classList.toggle('collapsed');
      const isCollapsed = this.classList.contains('collapsed');
      this.querySelector('span:last-child').textContent = isCollapsed ? 'Show Filters' : 'Hide Filters';
    });

    // Initialize table and pagination
    initializeTable();
  });

  function exportTableToCSV(filename = '') {
    const rows = document.querySelectorAll("table tr");
    const csv = [...rows].map(r =>
      [...r.querySelectorAll("th,td")]
        .map(c => `"${c.innerText.replace(/"/g,'""')}"`).join(",")
    ).join("\n");

    const blob = new Blob([csv], {type:'text/csv'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Chart.js
  const rowsData = <%- JSON.stringify(rowsData) %>;
  (function(){
    const years = [...new Set(rowsData.map(r => r.year))].sort((a,b)=> a-b);
    const sums = years.map(y => rowsData.filter(r=>r.year===y)
                                       .reduce((s,r)=> s + Number(r.total_year || 0), 0));
    if (!years.length) return;
    new Chart(document.getElementById("yearChart"), {
      type: 'bar',
      data: { labels: years, datasets: [{ label: 'Total per Year', backgroundColor: '#007bff', data: sums }] },
      options: { responsive:true, scales: { y: { beginAtZero:true } } }
    });
  })();
</script>
</body>
</html>


